<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>كود نيمز أونلاين - ناعم وفخم</title>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: #f0f0f0;
    margin: 0; padding: 0;
    display: flex; justify-content: center; align-items: center;
    height: 100vh;
    overflow: hidden;
  }
  #container {
    background: rgba(0,0,0,0.65);
    border-radius: 15px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.5);
    width: 400px;
    padding: 25px 30px;
    box-sizing: border-box;
  }
  header {
    font-size: 1.8rem;
    font-weight: 700;
    text-align: center;
    margin-bottom: 20px;
    letter-spacing: 2px;
  }
  input {
    width: 100%;
    padding: 12px 15px;
    margin: 10px 0;
    border: none;
    border-radius: 8px;
    font-size: 1rem;
    outline: none;
    transition: background-color 0.3s ease;
  }
  input:focus {
    background-color: #555;
  }
  button {
    width: 48%;
    padding: 12px 0;
    margin: 10px 1%;
    border: none;
    border-radius: 10px;
    background: #8b5cf6;
    color: white;
    font-weight: 700;
    font-size: 1.1rem;
    cursor: pointer;
    box-shadow: 0 5px 15px rgba(139, 92, 246, 0.5);
    transition: background-color 0.3s ease, transform 0.2s ease;
  }
  button:hover {
    background: #7c3aed;
    transform: scale(1.05);
  }
  button:active {
    transform: scale(0.95);
  }
  .hidden {
    display: none;
  }
  #error, #roleError {
    color: #ff6b6b;
    font-weight: 600;
    margin-top: 5px;
    min-height: 20px;
    text-align: center;
  }
  #roles {
    display: flex;
    justify-content: space-between;
    margin: 15px 0;
  }
  .role {
    flex: 1;
    margin: 0 5px;
    background: #444;
    padding: 12px 0;
    border-radius: 10px;
    cursor: pointer;
    font-weight: 600;
    transition: background-color 0.3s ease, box-shadow 0.3s ease;
    user-select: none;
  }
  .role:hover {
    background: #7c3aed;
    box-shadow: 0 0 10px #7c3aed;
  }
  .role.selected {
    background: #a78bfa;
    box-shadow: 0 0 15px #a78bfa;
  }
  /* شاشة اللعبة */
  #gameScreen {
    text-align: center;
  }
  #info {
    margin-bottom: 15px;
    font-size: 1.1rem;
    font-weight: 700;
  }
  #playersList {
    margin-bottom: 20px;
  }
  .playerCard {
    padding: 6px 12px;
    margin: 6px 4px;
    border-radius: 8px;
    display: inline-block;
    font-weight: 600;
    user-select: none;
    transition: background-color 0.3s ease;
  }
  .playerCard.red {
    background-color: #f87171;
  }
  .playerCard.blue {
    background-color: #60a5fa;
  }
  .playerCard.spy {
    background-color: #e879f9;
  }
  .playerCard.neutral {
    background-color: #9ca3af;
  }
  #board {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 10px;
    margin-bottom: 20px;
  }
  .card {
    background-color: #333;
    border-radius: 12px;
    padding: 12px;
    font-weight: 700;
    font-size: 1rem;
    cursor: pointer;
    user-select: none;
    color: #eee;
    transition: background-color 0.3s ease, transform 0.2s ease;
  }
  .card:hover {
    background-color: #555;
    transform: scale(1.05);
  }
  .card.revealed {
    cursor: default;
    color: white;
  }
  .card.red {
    background-color: #f87171 !important;
  }
  .card.blue {
    background-color: #60a5fa !important;
  }
  .card.neutral {
    background-color: #9ca3af !important;
    color: #222 !important;
  }
  .card.assassin {
    background-color: #1f2937 !important;
    color: #ef4444 !important;
    font-weight: 900;
  }
  #controls {
    display: flex;
    justify-content: space-around;
  }
  #controls button {
    width: 30%;
  }
</style>
</head>
<body>
  <div id="container">
    <header>كود نيمز أونلاين - ناعم وفخم</header>
    <div id="roomScreen">
      <h2>إنشاء أو دخول غرفة</h2>
      <input id="roomName" placeholder="اسم الغرفة" autocomplete="off" />
      <input id="roomPass" type="password" placeholder="كلمة السر" autocomplete="off" />
      <div id="error"></div>
      <div style="display:flex; justify-content:center; gap:12px;">
        <button id="createBtn">أنشئ غرفة</button>
        <button id="joinBtn">ادخل الغرفة</button>
      </div>
    </div>

    <div id="roleScreen" class="hidden">
      <h2>ادخل اسمك واختر دورك</h2>
      <input id="playerName" placeholder="اسمك" autocomplete="off" />
      <div id="roleError"></div>
      <div id="roles">
        <div class="role" data-role="spy">سباي ماستر</div>
        <div class="role" data-role="red">أحمر</div>
        <div class="role" data-role="blue">أزرق</div>
        <div class="role" data-role="neutral">مراقب</div>
      </div>
      <button id="joinGame">انضم للعبة</button>
    </div>

    <div id="gameScreen" class="hidden">
      <div id="info"></div>
      <div id="playersList"></div>
      <div id="board"></div>
      <div id="controls">
        <button id="pass">غيّر الدور</button>
        <button id="restart">إعادة اللعبة</button>
        <button id="leave">خروج</button>
      </div>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <script>
  // إعداد Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyDTAqaqpmPX0JYie21Gl2ysp1mHgKuw2EY",
    authDomain: "myupload-948bd.firebaseapp.com",
    databaseURL: "https://myupload-948bd-default-rtdb.firebaseio.com",
    projectId: "myupload-948bd",
    storageBucket: "myupload-948bd.appspot.com",
    messagingSenderId: "451397571101",
    appId: "1:451397571101:web:90b7cf96637819f734ecf4"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // كلمات اللعبة
  const wordsPool = [
    "جبل", "بحر", "قمر", "شمس", "نهر", "صحراء", "طيارة", "سيارة", "حصان", "قطار", "كمبيوتر", "جوال",
    "مدينة", "قرية", "شارع", "مدرسة", "جامعة", "مستشفى", "كتاب", "قلم", "كوب", "ساعة", "شباك", "باب",
    "نار", "ثلج", "مطر", "ريح", "غيمة", "ظلال", "ضوء", "ظلام", "أمل", "حب", "صداقة", "عدو", "قوة", "ضعف",
    "علم", "جهل", "سر", "حقيقة", "خداع", "نفاق", "إخلاص", "خوف", "شجاعة", "أمن", "حرب", "سلام", "سياسة",
    "اقتصاد", "نفط", "ذهب", "فضة", "حديد", "تراب", "ماء", "هواء", "خشب", "زجاج", "ملح", "سكر", "فلفل",
    "خبز", "أرز", "تفاح", "موز", "برتقال", "عنب", "توت", "ليمون", "بطيخ", "تمر", "جزر", "طماطم", "بصل",
    "ثوم", "خيار", "قرع", "مطبخ", "حمام", "غرفة", "بيت", "قصر", "كوخ", "معبد", "كنيسة", "مسجد", "سوق",
    "مول", "مطعم", "مقهى", "مطار", "ميناء", "محطة", "بنك", "مكتب", "مصنع", "مزرعة", "حديقة", "غابة",
    "شاطئ", "سفينة", "باخرة", "غواصة", "دبابة", "مسدس", "بندقية", "سيف", "رمح", "درع", "خوذة", "جيش",
    "شرطة", "حارس", "لص", "قاتل", "ساحر", "شاعر", "كاتب", "رسام", "فنان", "موسيقي", "مطرب", "ممثّل",
    "رياضي", "لاعب", "مدرب", "حكم", "مشجع", "سباق", "مباراة", "بطولة", "كأس", "ميدالية", "كرة", "شبكة",
    "قفاز", "خوذة", "نظارة", "سماعة", "حذاء", "جاكيت", "قميص", "بنطلون", "تنورة", "فستان", "بدلة", "حزام",
    "شنطة", "مفتاح", "مقص", "مطرقة", "مسمار", "مبرد", "منشار", "كماشة", "مغناطيس", "بطارية", "مصباح",
    "كاميرا", "تلفاز", "راديو", "ميكروفون", "لوحة", "خريطة", "ساعة حائط", "مروحة", "مكيف", "ثلاجة",
    "فرن", "موقد", "غلاية", "قدر", "ملعقة", "شوكة", "سكين", "صحن", "كأس ماء", "زبدية", "صينية",
    "كنبة", "كرسي", "طاولة", "دولاب", "مرآة", "سجادة", "ستارة", "وسادة", "بطانية", "مرتبة",
    "زر", "حبل", "شريط", "صندوق", "علبة", "دبوس", "مشبك", "قفل", "سلسلة", "إطار",
    "درج", "ممر", "سطح", "قبو", "حديقة منزلية", "مرآب", "بوابة", "مدخل", "مخرج", "رواق",
    "ثريا", "شمعة", "مصباح يدوي", "ولاعة", "ولاعة كهربائية", "مصباح مكتب", "ضوء نيون", "كشاف",
  ];

  // أزرار وعناصر
  const roomScreen = document.getElementById("roomScreen");
  const roleScreen = document.getElementById("roleScreen");
  const gameScreen = document.getElementById("gameScreen");

  const roomNameInput = document.getElementById("roomName");
  const roomPassInput = document.getElementById("roomPass");
  const createBtn = document.getElementById("createBtn");
  const joinBtn = document.getElementById("joinBtn");
  const errorDiv = document.getElementById("error");

  const playerNameInput = document.getElementById("playerName");
  const rolesDiv = document.getElementById("roles");
  const joinGameBtn = document.getElementById("joinGame");
  const roleErrorDiv = document.getElementById("roleError");

  const infoDiv = document.getElementById("info");
  const playersListDiv = document.getElementById("playersList");
  const boardDiv = document.getElementById("board");
  const passBtn = document.getElementById("pass");
  const restartBtn = document.getElementById("restart");
  const leaveBtn = document.getElementById("leave");

  // متغيرات الحالة
  let currentRoom = null;
  let currentPass = null;
  let players = {};
  let board = [];
  let turn = "red";
  let redLeft = 9;
  let blueLeft = 8;
  let gameEnded = false;
  let playerId = null;
  let playerRole = null;
  let playerName = null;

  // اختيار دور
  rolesDiv.addEventListener("click", e => {
    if(!e.target.classList.contains("role")) return;
    [...rolesDiv.children].forEach(r => r.classList.remove("selected"));
    e.target.classList.add("selected");
    playerRole = e.target.dataset.role;
  });

  // إنشاء غرفة
  createBtn.onclick = async () => {
    errorDiv.textContent = "";
    const room = roomNameInput.value.trim();
    const pass = roomPassInput.value.trim();
    if(!room) return errorDiv.textContent = "لازم تكتب اسم الغرفة.";
    if(!pass) return errorDiv.textContent = "لازم تكتب كلمة السر.";

    const roomRef = db.ref("rooms/" + room);
    const snapshot = await roomRef.get();
    if(snapshot.exists()){
      errorDiv.textContent = "الغرفة موجودة، استخدم 'ادخل الغرفة'.";
      return;
    }

    // إنشاء بيانات الغرفة الجديدة
    await roomRef.set({
      pass,
      players: {},
      board: [],
      turn: "red",
      redLeft: 9,
      blueLeft: 8,
      gameEnded: false,
    });

    currentRoom = room;
    currentPass = pass;

    showRoleScreen();
  };

  // دخول غرفة
  joinBtn.onclick = async () => {
    errorDiv.textContent = "";
    const room = roomNameInput.value.trim();
    const pass = roomPassInput.value.trim();
    if(!room) return errorDiv.textContent = "اكتب اسم الغرفة.";
    if(!pass) return errorDiv.textContent = "اكتب كلمة السر.";

    const roomRef = db.ref("rooms/" + room);
    const snapshot = await roomRef.get();
    if(!snapshot.exists()){
      errorDiv.textContent = "الغرفة غير موجودة.";
      return;
    }

    const data = snapshot.val();
    if(data.pass !== pass){
      errorDiv.textContent = "كلمة السر خاطئة.";
      return;
    }

    currentRoom = room;
    currentPass = pass;

    showRoleScreen();
  };

  // انضمام للعبة بعد اختيار الاسم والدور
  joinGameBtn.onclick = async () => {
    roleErrorDiv.textContent = "";
    playerName = playerNameInput.value.trim();
    if(!playerName) return roleErrorDiv.textContent = "اكتب اسمك.";
    if(!playerRole) return roleErrorDiv.textContent = "اختار دورك.";

    playerId = generateId();

    const playerData = {
      name: playerName,
      role: playerRole,
      id: playerId,
      score: 0
    };

    // إضافة اللاعب للغرفة في الفايربيس
    const playerRef = db.ref(`rooms/${currentRoom}/players/${playerId}`);
    await playerRef.set(playerData);

    subscribeToRoom();

    showGameScreen();
  };

  // توليد معرّف عشوائي
  function generateId(){
    return Math.random().toString(36).substr(2,9);
  }

  // الاشتراك لتحديث الغرفة
  let unsubscribe = null;
  function subscribeToRoom(){
    if(unsubscribe) unsubscribe();
    const roomRef = db.ref("rooms/" + currentRoom);
    unsubscribe = roomRef.on("value", snapshot => {
      if(!snapshot.exists()) return;
      const data = snapshot.val();

      // تحقق من كلمة السر
      if(data.pass !== currentPass){
        alert("تم تغيير كلمة السر أو تم حذف الغرفة.");
        leaveRoom();
        return;
      }

      players = data.players || {};
      board = data.board || [];
      turn = data.turn || "red";
      redLeft = data.redLeft ?? 9;
      blueLeft = data.blueLeft ?? 8;
      gameEnded = data.gameEnded || false;

      updateGameUI();
    });
  }

  // تحديث واجهة اللعبة
  function updateGameUI(){
    // معلومات الدور واللاعب
    infoDiv.textContent = `دور: ${turn === "red" ? "الأحمر" : "الأزرق"} | أنت: ${playerName} (${playerRole})`;

    // قائمة اللاعبين
    playersListDiv.innerHTML = "";
    Object.values(players).forEach(p => {
      const div = document.createElement("div");
      div.textContent = p.name + (p.id === playerId ? " (أنت)" : "");
      div.classList.add("playerCard");
      div.classList.add(p.role);
      playersListDiv.appendChild(div);
    });

    // عرض اللوحة
    boardDiv.innerHTML = "";
    board.forEach((card, i) => {
      const cardDiv = document.createElement("div");
      cardDiv.classList.add("card");
      if(card.revealed) cardDiv.classList.add("revealed");

      if(card.type === "red") cardDiv.classList.add("red");
      else if(card.type === "blue") cardDiv.classList.add("blue");
      else if(card.type === "neutral") cardDiv.classList.add("neutral");
      else if(card.type === "assassin") cardDiv.classList.add("assassin");

      cardDiv.textContent = card.word;
      boardDiv.appendChild(cardDiv);

      if(!card.revealed && !gameEnded && playerRole !== "spy"){
        cardDiv.onclick = () => {
          if(turn !== playerRole) return;
          revealCard(i);
        };
      }
    });

    passBtn.disabled = playerRole !== "spy" || gameEnded;
    restartBtn.disabled = !gameEnded && playerRole !== "spy";
  }

  // كشف بطاقة
  async function revealCard(index){
    if(gameEnded) return;

    const card = board[index];
    if(card.revealed) return;

    card.revealed = true;

    // تحديث الأعداد حسب البطاقة
    if(card.type === "red") redLeft--;
    else if(card.type === "blue") blueLeft--;

    // تغيير الدور أو انتهاء اللعبة
    if(card.type === "assassin"){
      gameEnded = true;
      alert(`انتهت اللعبة! الخاسر هو فريق ${turn === "red" ? "الأحمر" : "الأزرق"}`);
    } else if(redLeft === 0){
      gameEnded = true;
      alert("انتهت اللعبة! الفريق الأحمر فاز 🎉");
    } else if(blueLeft === 0){
      gameEnded = true;
      alert("انتهت اللعبة! الفريق الأزرق فاز 🎉");
    } else if(card.type !== turn){
      turn = turn === "red" ? "blue" : "red";
    }

    // تحديث بيانات الغرفة
    const roomRef = db.ref("rooms/" + currentRoom);
    await roomRef.update({
      board,
      turn,
      redLeft,
      blueLeft,
      gameEnded
    });
  }

  // تغيير الدور (لكل سباي ماستر فقط)
  passBtn.onclick = async () => {
    if(playerRole !== "spy") return;
    if(gameEnded) return;

    turn = turn === "red" ? "blue" : "red";
    const roomRef = db.ref("rooms/" + currentRoom);
    await roomRef.update({ turn });
  };

  // إعادة اللعبة (لكل سباي ماستر فقط)
  restartBtn.onclick = async () => {
    if(playerRole !== "spy") return;

    // إعادة تهيئة اللعبة
    board = generateBoard();
    turn = "red";
    redLeft = 9;
    blueLeft = 8;
    gameEnded = false;

    const roomRef = db.ref("rooms/" + currentRoom);
    await roomRef.update({
      board,
      turn,
      redLeft,
      blueLeft,
      gameEnded
    });
  };

  // خروج من الغرفة
  leaveBtn.onclick = () => {
    leaveRoom();
  };

  // ترك الغرفة وتنظيف
  async function leaveRoom(){
    if(unsubscribe) unsubscribe();
    if(playerId){
      const playerRef = db.ref(`rooms/${currentRoom}/players/${playerId}`);
      await playerRef.remove();
    }
    currentRoom = null;
    currentPass = null;
    playerRole = null;
    playerName = null;
    playerId = null;
    players = {};
    board = [];
    gameEnded = false;
    turn = "red";
    redLeft = 9;
    blueLeft = 8;

    roleScreen.classList.add("hidden");
    gameScreen.classList.add("hidden");
    roomScreen.classList.remove("hidden");
  }

  // عرض شاشة اختيار الاسم والدور
  function showRoleScreen(){
    roomScreen.classList.add("hidden");
    roleScreen.classList.remove("hidden");
    gameScreen.classList.add("hidden");
  }

  // عرض شاشة اللعبة
  function showGameScreen(){
    roomScreen.classList.add("hidden");
    roleScreen.classList.add("hidden");
    gameScreen.classList.remove("hidden");
  }

  // إنشاء لوحة اللعبة الجديدة
  function generateBoard(){
    // اختيار 25 كلمة عشوائية بدون تكرار
    const shuffled = wordsPool.sort(() => 0.5 - Math.random());
    const selectedWords = shuffled.slice(0, 25);

    // توزيع الأدوار على الكلمات
    const types = [];
    for(let i=0; i<9; i++) types.push("red");
    for(let i=0; i<8; i++) types.push("blue");
    for(let i=0; i<7; i++) types.push("neutral");
    types.push("assassin");

    // خلط الأدوار
    types.sort(() => 0.5 - Math.random());

    // بناء اللوحة
    const board = selectedWords.map((word, i) => ({
      word,
      type: types[i],
      revealed: false,
    }));
    return board;
  }
  </script>
</body>
</html>
