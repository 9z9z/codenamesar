<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>كود نيمز أونلاين - مودرن وفخم</title>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f7f9fc;
    color: #222;
    margin: 0; padding: 0;
  }
  header {
    background: #2c3e50;
    color: #ecf0f1;
    text-align: center;
    padding: 1rem;
    font-size: 1.8rem;
    font-weight: bold;
    letter-spacing: 2px;
  }
  #container {
    max-width: 900px;
    margin: 1rem auto;
    padding: 1rem;
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 0 12px rgba(0,0,0,0.1);
  }
  input, button {
    font-size: 1.1rem;
    padding: 0.6rem 1rem;
    margin: 0.3rem 0.6rem 0.6rem 0;
    border-radius: 6px;
    border: 1px solid #ccc;
  }
  input:focus {
    outline: none;
    border-color: #2980b9;
    box-shadow: 0 0 5px #2980b9;
  }
  button {
    cursor: pointer;
    background: #2980b9;
    color: white;
    border: none;
    transition: background-color 0.3s ease;
  }
  button:hover {
    background: #1c5980;
  }
  .hidden {
    display: none;
  }
  h2 {
    margin-top: 0;
    color: #34495e;
  }
  #roles button {
    background: #bdc3c7;
    margin: 0.3rem 0.5rem 0.5rem 0;
  }
  #roles button.selected {
    background: #2980b9;
    color: white;
  }
  #board {
    margin-top: 1rem;
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 10px;
  }
  .card {
    background: #ecf0f1;
    border-radius: 8px;
    padding: 1rem;
    text-align: center;
    font-weight: 700;
    font-size: 1.2rem;
    cursor: pointer;
    user-select: none;
    transition: background-color 0.3s ease;
  }
  .card.red { background: #e74c3c; color: white; }
  .card.blue { background: #3498db; color: white; }
  .card.neutral { background: #95a5a6; color: white; }
  .card.assassin { background: #2c3e50; color: white; }
  .card.guessed {
    opacity: 0.6;
    cursor: default;
  }
  #playersList {
    margin-top: 1rem;
    font-weight: 600;
  }
  #info {
    margin-top: 1rem;
    font-size: 1.3rem;
    font-weight: bold;
  }
  #controls {
    margin-top: 1rem;
  }
  #error, #roleError {
    color: #e74c3c;
    margin: 0.5rem 0;
  }
</style>
</head>
<body>

<header>كود نيمز أونلاين - مودرن وفخم</header>
<div id="container">

  <div id="roomScreen">
    <h2>أنشئ أو ادخل غرفة</h2>
    <input id="roomName" placeholder="اسم الغرفة" />
    <button id="createBtn">إنشئ الغرفة</button>
    <button id="joinBtn">ادخل الغرفة</button>
    <div id="error"></div>

    <h3>الغرف المفتوحة</h3>
    <ul id="publicRooms"></ul>
  </div>

  <div id="roleScreen" class="hidden">
    <h2>ادخل اسمك واختر دورك</h2>
    <input id="playerName" placeholder="اسمك" />
    <div id="roles">
      <button class="role" data-role="spy">سباي ماستر</button>
      <button class="role" data-role="red">فريق أحمر</button>
      <button class="role" data-role="blue">فريق أزرق</button>
      <button class="role" data-role="neutral">مراقب</button>
    </div>
    <button id="joinGame">انضم للعبة</button>
    <div id="roleError"></div>
  </div>

  <div id="gameScreen" class="hidden">
    <div id="info"></div>
    <div id="playersList"></div>
    <div id="board"></div>
    <div id="controls">
      <button id="pass">غيّر الدور</button>
      <button id="restart">إعادة اللعبة</button>
      <button id="leave">غادر الغرفة</button>
    </div>
  </div>

</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
  import { getDatabase, ref, set, get, onValue, push, update, remove, child } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDTAqaqpmPX0JYie21Gl2ysp1mHgKuw2EY",
    authDomain: "myupload-948bd.firebaseapp.com",
    databaseURL: "https://myupload-948bd-default-rtdb.firebaseio.com",
    projectId: "myupload-948bd",
    storageBucket: "myupload-948bd.appspot.com",
    messagingSenderId: "451397571101",
    appId: "1:451397571101:web:90b7cf96637819f734ecf4"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // كلمات اللعبة - زودتها أكثر من 100 كلمة (تقدر تضيف أكثر حسب الحاجة)
  const wordsPool = [
    "جبل", "بحر", "قمر", "شمس", "نهر", "صحراء", "طيارة", "سيارة", "حصان", "قطار",
    "كمبيوتر", "جوال", "مدينة", "قرية", "شارع", "مدرسة", "جامعة", "مستشفى", "كتاب",
    "قلم", "كوب", "ساعة", "شباك", "باب", "نار", "ثلج", "مطر", "ريح", "غيمة", "ظل",
    "ضوء", "ظلام", "أمل", "حب", "صداقة", "عدو", "قوة", "ضعف", "علم", "جهل", "سر",
    "حقيقة", "خداع", "نفاق", "إخلاص", "خوف", "شجاعة", "أمن", "حرب", "سلام", "سياسة",
    "اقتصاد", "نفط", "ذهب", "فضة", "حديد", "تراب", "ماء", "هواء", "خشب", "زجاج",
    "ملح", "سكر", "فلفل", "بحيرة", "وادي", "شجرة", "زهرة", "طيور", "أسد", "نمر",
    "ذئب", "عسل", "قهوة", "شاي", "مطبخ", "مسرح", "سينما", "فن", "موسيقى", "رياضة",
    "كرة", "سباحة", "جري", "قفز", "سماء", "نجوم", "قمر صناعي", "بركان", "زلازل",
    "عاصفة", "ثلوج", "صيف", "شتاء", "خريف", "ربيع"
  ];

  function shuffle(array) {
    for (let i = array.length -1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
  }

  // متغيرات الحالة
  let currentRoom = null;
  let currentUserId = null;
  let currentUserRole = null;
  let currentUserName = null;
  let currentGameData = null;

  // عناصر الصفحة
  const roomScreen = document.getElementById('roomScreen');
  const roleScreen = document.getElementById('roleScreen');
  const gameScreen = document.getElementById('gameScreen');
  const errorDiv = document.getElementById('error');
  const roleErrorDiv = document.getElementById('roleError');
  const roomNameInput = document.getElementById('roomName');
  const createBtn = document.getElementById('createBtn');
  const joinBtn = document.getElementById('joinBtn');
  const playerNameInput = document.getElementById('playerName');
  const rolesDiv = document.getElementById('roles');
  const joinGameBtn = document.getElementById('joinGame');
  const infoDiv = document.getElementById('info');
  const playersListDiv = document.getElementById('playersList');
  const boardDiv = document.getElementById('board');
  const passBtn = document.getElementById('pass');
  const restartBtn = document.getElementById('restart');
  const leaveBtn = document.getElementById('leave');
  const publicRoomsUl = document.getElementById('publicRooms');

  // تحديد الدور المحدد
  let selectedRole = null;
  rolesDiv.addEventListener('click', e => {
    if(e.target.classList.contains('role')) {
      [...rolesDiv.children].forEach(b => b.classList.remove('selected'));
      e.target.classList.add('selected');
      selectedRole = e.target.dataset.role;
    }
  });

  // تحديث قائمة الغرف المفتوحة
  function updatePublicRooms() {
    const roomsRef = ref(db, 'rooms');
    onValue(roomsRef, snapshot => {
      const rooms = snapshot.val() || {};
      publicRoomsUl.innerHTML = '';
      Object.entries(rooms).forEach(([roomId, room]) => {
        // لو الغرفة عدد اللاعبين فيها أقل من 4 تبقى ظاهرة
        if(room.players && Object.keys(room.players).length < 4) {
          const li = document.createElement('li');
          li.textContent = room.name + ` ( ${Object.keys(room.players).length} / 4 )`;
          li.style.cursor = 'pointer';
          li.onclick = () => {
            roomNameInput.value = room.name;
          };
          publicRoomsUl.appendChild(li);
        }
      });
    });
  }

  updatePublicRooms();

  // إنشاء غرفة جديدة
  createBtn.onclick = async () => {
    const roomName = roomNameInput.value.trim();
    if(!roomName) {
      errorDiv.textContent = 'اكتب اسم الغرفة أولاً';
      return;
    }
    errorDiv.textContent = '';
    // نتأكد إن الغرفة ما موجودة
    const roomRef = ref(db, `rooms/${roomName}`);
    const snapshot = await get(roomRef);
    if(snapshot.exists()) {
      errorDiv.textContent = 'الغرفة موجودة، حاول اسم ثاني';
      return;
    }
    // أنشئ غرفة جديدة
    await set(roomRef, {
      name: roomName,
      players: {},
      board: [],
      turn: 'red',
      redLeft: 9,
      blueLeft: 8,
      gameEnded: false,
    });
    enterRoleScreen(roomName);
  };

  // دخول غرفة موجودة
  joinBtn.onclick = async () => {
    const roomName = roomNameInput.value.trim();
    if(!roomName) {
      errorDiv.textContent = 'اكتب اسم الغرفة أولاً';
      return;
    }
    errorDiv.textContent = '';
    const roomRef = ref(db, `rooms/${roomName}`);
    const snapshot = await get(roomRef);
    if(!snapshot.exists()) {
      errorDiv.textContent = 'الغرفة غير موجودة';
      return;
    }
    // نتحقق إذا الغرفة مليانة
    const roomData = snapshot.val();
    if(roomData.players && Object.keys(roomData.players).length >= 4) {
      errorDiv.textContent = 'الغرفة مليانة، حاول غرفة ثانية';
      return;
    }
    enterRoleScreen(roomName);
  };

  // نروح لشاشة اختيار الدور
  function enterRoleScreen(roomName) {
    currentRoom = roomName;
    roomScreen.classList.add('hidden');
    roleScreen.classList.remove('hidden');
    gameScreen.classList.add('hidden');
    selectedRole = null;
    playerNameInput.value = '';
    roleErrorDiv.textContent = '';
  }

  // انضمام للعبة
  joinGameBtn.onclick = async () => {
    const name = playerNameInput.value.trim();
    if(!name) {
      roleErrorDiv.textContent = 'اكتب اسمك';
      return;
    }
    if(!selectedRole) {
      roleErrorDiv.textContent = 'اختر دور';
      return;
    }
    roleErrorDiv.textContent = '';

    // نتحقق من الغرفة وعدد اللاعبين وأدوارهم
    const roomRef = ref(db, `rooms/${currentRoom}`);
    const snapshot = await get(roomRef);
    if(!snapshot.exists()) {
      roleErrorDiv.textContent = 'الغرفة انحذفت';
      return;
    }
    const roomData = snapshot.val();
    const players = roomData.players || {};
    // نتأكد الدور ما مكرر (2 سباي ماستر، 1 أحمر، 1 أزرق، مراقب 1 كحد أقصى)
    let counts = {spy:0, red:0, blue:0, neutral:0};
    Object.values(players).forEach(p => {
      counts[p.role] = (counts[p.role]||0)+1;
    });
    if(selectedRole === 'spy' && counts.spy >= 2) {
      roleErrorDiv.textContent = 'ما تقدر تختار أكثر من سباي ماستر اثنين';
      return;
    }
    if(selectedRole === 'red' && counts.red >= 1) {
      roleErrorDiv.textContent = 'فريق أحمر مكتمل';
      return;
    }
    if(selectedRole === 'blue' && counts.blue >= 1) {
      roleErrorDiv.textContent = 'فريق أزرق مكتمل';
      return;
    }
    if(selectedRole === 'neutral' && counts.neutral >= 1) {
      roleErrorDiv.textContent = 'المراقب موجود';
      return;
    }

    // كل شيء تمام نضيف اللاعب
    const userId = push(ref(db, `rooms/${currentRoom}/players`)).key;
    await update(ref(db, `rooms/${currentRoom}/players/${userId}`), {
      name,
      role: selectedRole,
      guessed: false
    });
    currentUserId = userId;
    currentUserRole = selectedRole;
    currentUserName = name;

    roleScreen.classList.add('hidden');
    gameScreen.classList.remove('hidden');

    startListeningRoom();
  };

  // استمع لتغيرات الغرفة عشان تحدث اللعبة
  function startListeningRoom() {
    const roomRef = ref(db, `rooms/${currentRoom}`);
    onValue(roomRef, snapshot => {
      const data = snapshot.val();
      if(!data) {
        alert("الغرفة انحذفت أو غير متاحة.");
        location.reload();
        return;
      }
      currentGameData = data;
      updateGameUI();
    });
  }

  // تحديث واجهة اللعبة
  function updateGameUI() {
    if(!currentGameData) return;

    // معلومات عامة
    infoDiv.textContent = `دور: ${currentGameData.turn} - أحمر باقي: ${currentGameData.redLeft} - أزرق باقي: ${currentGameData.blueLeft}`;

    // قائمة اللاعبين
    let playersHtml = '<strong>اللاعبين:</strong><br>';
    for(const [id, p] of Object.entries(currentGameData.players || {})) {
      playersHtml += `${p.name} - ${p.role}${id === currentUserId ? ' (أنت)' : ''}<br>`;
    }
    playersListDiv.innerHTML = playersHtml;

    // تحضير اللوح إذا فاضي
    if(currentGameData.board.length === 0) {
      prepareBoard();
    } else {
      renderBoard();
    }
  }

  // جهز اللوح
  async function prepareBoard() {
    let words = shuffle([...wordsPool]).slice(0, 25);
    // توزيع الأدوار للوح: 9 أحمر، 8 أزرق، 7 محايد، 1 قاتل
    let rolesArray = [];
    if(currentGameData.turn === 'red') {
      rolesArray = [...Array(9).fill('red'), ...Array(8).fill('blue'), ...Array(7).fill('neutral'), 'assassin'];
    } else {
      rolesArray = [...Array(8).fill('red'), ...Array(9).fill('blue'), ...Array(7).fill('neutral'), 'assassin'];
    }
    rolesArray = shuffle(rolesArray);

    const board = words.map((word, i) => {
      return { word, role: rolesArray[i], guessed: false };
    });

    // احفظ اللوح في Firebase
    await update(ref(db, `rooms/${currentRoom}`), {
      board,
      redLeft: rolesArray.filter(r => r === 'red').length,
      blueLeft: rolesArray.filter(r => r === 'blue').length,
      gameEnded: false,
      turn: currentGameData.turn
    });
  }

  // عرض اللوح
  function renderBoard() {
    boardDiv.innerHTML = '';
    currentGameData.board.forEach((card, idx) => {
      const div = document.createElement('div');
      div.classList.add('card');
      div.textContent = card.word;

      if(card.guessed) div.classList.add('guessed');

      // ألوان حسب الدور، سباي ماستر يشوف كل الألوان، الفرق يشوفون ألوانهم فقط، المحايد قاتل يظل رمادي
      if(currentUserRole === 'spy') {
        div.classList.add(card.role);
      } else {
        if(card.guessed) {
          div.classList.add(card.role);
        } else {
          if(currentUserRole === 'red' && card.role === 'red') div.classList.add('red');
          else if(currentUserRole === 'blue' && card.role === 'blue') div.classList.add('blue');
          else div.classList.add('neutral');
        }
      }

      // يسمح فقط لأعضاء الفرق بوضع تخمينهم
      if(!card.guessed && (currentUserRole === 'red' || currentUserRole === 'blue')) {
        div.style.cursor = 'pointer';
        div.onclick = () => guessCard(idx);
      }

      boardDiv.appendChild(div);
    });
  }

  // تخمين بطاقة
  async function guessCard(idx) {
    if(currentGameData.gameEnded) return alert('اللعبة انتهت');
    if(currentGameData.turn !== currentUserRole) return alert('مش دورك');

    const card = currentGameData.board[idx];
    if(card.guessed) return;

    const newBoard = [...currentGameData.board];
    newBoard[idx].guessed = true;

    // حدّث الأعداد المتبقية حسب الدور
    let redLeft = currentGameData.redLeft;
    let blueLeft = currentGameData.blueLeft;
    if(card.role === 'red') redLeft--;
    else if(card.role === 'blue') blueLeft--;

    // تحقق من القاتل (assassin) => اللعبة تنتهي
    let gameEnded = false;
    let winner = null;
    if(card.role === 'assassin') {
      gameEnded = true;
      winner = currentGameData.turn === 'red' ? 'blue' : 'red';
      alert(`انتهت اللعبة! الفريق الفائز: ${winner}`);
    } else if(redLeft === 0) {
      gameEnded = true;
      winner = 'red';
      alert('انتهت اللعبة! الفريق الأحمر فاز.');
    } else if(blueLeft === 0) {
      gameEnded = true;
      winner = 'blue';
      alert('انتهت اللعبة! الفريق الأزرق فاز.');
    }

    // إذا الفريق خمن كلمة غير منطقية (مش من فريقه ولا محايد) أو قاتل => يغير الدور فورًا
    let nextTurn = currentGameData.turn;
    if(card.role !== currentGameData.turn) {
      nextTurn = currentGameData.turn === 'red' ? 'blue' : 'red';
    }

    // حدث اللعبة في Firebase
    await update(ref(db, `rooms/${currentRoom}`), {
      board: newBoard,
      redLeft,
      blueLeft,
      turn: gameEnded ? currentGameData.turn : nextTurn,
      gameEnded
    });
  }

  // زر تغيير الدور
  passBtn.onclick = async () => {
    if(currentGameData.gameEnded) return alert('اللعبة انتهت');
    if(currentGameData.turn !== currentUserRole) return alert('مش دورك');
    const nextTurn = currentGameData.turn === 'red' ? 'blue' : 'red';
    await update(ref(db, `rooms/${currentRoom}`), {
      turn: nextTurn
    });
  };

  // إعادة اللعبة
  restartBtn.onclick = async () => {
    if(currentUserRole !== 'spy') return alert('بس سباي ماستر يقدر يعيد اللعبة');
    await update(ref(db, `rooms/${currentRoom}`), {
      board: [],
      gameEnded: false,
      turn: 'red'
    });
  };

  // غادر الغرفة
  leaveBtn.onclick = async () => {
    if(!currentUserId) return location.reload();
    await remove(ref(db, `rooms/${currentRoom}/players/${currentUserId}`));
    location.reload();
  };
</script>

</body>
</html>
