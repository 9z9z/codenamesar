<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ÙƒÙˆØ¯ Ù†ÙŠÙ…Ø² Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† - Ù†Ø§Ø¹Ù… ÙˆÙØ®Ù…</title>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: #f0f0f0;
    margin: 0; padding: 0;
    display: flex; justify-content: center; align-items: center;
    height: 100vh;
    overflow: hidden;
  }
  #container {
    background: rgba(0,0,0,0.65);
    border-radius: 15px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.5);
    width: 400px;
    padding: 25px 30px;
    box-sizing: border-box;
  }
  header {
    font-size: 1.8rem;
    font-weight: 700;
    text-align: center;
    margin-bottom: 20px;
    letter-spacing: 2px;
  }
  input {
    width: 100%;
    padding: 12px 15px;
    margin: 10px 0;
    border: none;
    border-radius: 8px;
    font-size: 1rem;
    outline: none;
    transition: background-color 0.3s ease;
  }
  input:focus {
    background-color: #555;
  }
  button {
    width: 48%;
    padding: 12px 0;
    margin: 10px 1%;
    border: none;
    border-radius: 10px;
    background: #8b5cf6;
    color: white;
    font-weight: 700;
    font-size: 1.1rem;
    cursor: pointer;
    box-shadow: 0 5px 15px rgba(139, 92, 246, 0.5);
    transition: background-color 0.3s ease, transform 0.2s ease;
  }
  button:hover {
    background: #7c3aed;
    transform: scale(1.05);
  }
  button:active {
    transform: scale(0.95);
  }
  .hidden {
    display: none;
  }
  #error, #roleError {
    color: #ff6b6b;
    font-weight: 600;
    margin-top: 5px;
    min-height: 20px;
    text-align: center;
  }
  #roles {
    display: flex;
    justify-content: space-between;
    margin: 15px 0;
  }
  .role {
    flex: 1;
    margin: 0 5px;
    background: #444;
    padding: 12px 0;
    border-radius: 10px;
    cursor: pointer;
    font-weight: 600;
    transition: background-color 0.3s ease, box-shadow 0.3s ease;
    user-select: none;
  }
  .role:hover {
    background: #7c3aed;
    box-shadow: 0 0 10px #7c3aed;
  }
  .role.selected {
    background: #a78bfa;
    box-shadow: 0 0 15px #a78bfa;
  }
  /* Ø´Ø§Ø´Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© */
  #gameScreen {
    text-align: center;
  }
  #info {
    margin-bottom: 15px;
    font-size: 1.1rem;
    font-weight: 700;
  }
  #playersList {
    margin-bottom: 20px;
  }
  .playerCard {
    padding: 6px 12px;
    margin: 6px 4px;
    border-radius: 8px;
    display: inline-block;
    font-weight: 600;
    user-select: none;
    transition: background-color 0.3s ease;
  }
  .playerCard.red {
    background-color: #f87171;
  }
  .playerCard.blue {
    background-color: #60a5fa;
  }
  .playerCard.spy {
    background-color: #e879f9;
  }
  .playerCard.neutral {
    background-color: #9ca3af;
  }
  #board {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 10px;
    margin-bottom: 20px;
  }
  .card {
    background-color: #333;
    border-radius: 12px;
    padding: 12px;
    font-weight: 700;
    font-size: 1rem;
    cursor: pointer;
    user-select: none;
    color: #eee;
    transition: background-color 0.3s ease, transform 0.2s ease;
  }
  .card:hover {
    background-color: #555;
    transform: scale(1.05);
  }
  .card.revealed {
    cursor: default;
    color: white;
  }
  .card.red {
    background-color: #f87171 !important;
  }
  .card.blue {
    background-color: #60a5fa !important;
  }
  .card.neutral {
    background-color: #9ca3af !important;
    color: #222 !important;
  }
  .card.assassin {
    background-color: #1f2937 !important;
    color: #ef4444 !important;
    font-weight: 900;
  }
  #controls {
    display: flex;
    justify-content: space-around;
  }
  #controls button {
    width: 30%;
  }
</style>
</head>
<body>
  <div id="container">
    <header>ÙƒÙˆØ¯ Ù†ÙŠÙ…Ø² Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† - Ù†Ø§Ø¹Ù… ÙˆÙØ®Ù…</header>
    <div id="roomScreen">
      <h2>Ø¥Ù†Ø´Ø§Ø¡ Ø£Ùˆ Ø¯Ø®ÙˆÙ„ ØºØ±ÙØ©</h2>
      <input id="roomName" placeholder="Ø§Ø³Ù… Ø§Ù„ØºØ±ÙØ©" autocomplete="off" />
      <input id="roomPass" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±" autocomplete="off" />
      <div id="error"></div>
      <div style="display:flex; justify-content:center; gap:12px;">
        <button id="createBtn">Ø£Ù†Ø´Ø¦ ØºØ±ÙØ©</button>
        <button id="joinBtn">Ø§Ø¯Ø®Ù„ Ø§Ù„ØºØ±ÙØ©</button>
      </div>
    </div>

    <div id="roleScreen" class="hidden">
      <h2>Ø§Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ ÙˆØ§Ø®ØªØ± Ø¯ÙˆØ±Ùƒ</h2>
      <input id="playerName" placeholder="Ø§Ø³Ù…Ùƒ" autocomplete="off" />
      <div id="roleError"></div>
      <div id="roles">
        <div class="role" data-role="spy">Ø³Ø¨Ø§ÙŠ Ù…Ø§Ø³ØªØ±</div>
        <div class="role" data-role="red">Ø£Ø­Ù…Ø±</div>
        <div class="role" data-role="blue">Ø£Ø²Ø±Ù‚</div>
        <div class="role" data-role="neutral">Ù…Ø±Ø§Ù‚Ø¨</div>
      </div>
      <button id="joinGame">Ø§Ù†Ø¶Ù… Ù„Ù„Ø¹Ø¨Ø©</button>
    </div>

    <div id="gameScreen" class="hidden">
      <div id="info"></div>
      <div id="playersList"></div>
      <div id="board"></div>
      <div id="controls">
        <button id="pass">ØºÙŠÙ‘Ø± Ø§Ù„Ø¯ÙˆØ±</button>
        <button id="restart">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©</button>
        <button id="leave">Ø®Ø±ÙˆØ¬</button>
      </div>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <script>
  // Ø¥Ø¹Ø¯Ø§Ø¯ Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyDTAqaqpmPX0JYie21Gl2ysp1mHgKuw2EY",
    authDomain: "myupload-948bd.firebaseapp.com",
    databaseURL: "https://myupload-948bd-default-rtdb.firebaseio.com",
    projectId: "myupload-948bd",
    storageBucket: "myupload-948bd.appspot.com",
    messagingSenderId: "451397571101",
    appId: "1:451397571101:web:90b7cf96637819f734ecf4"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø©
  const wordsPool = [
    "Ø¬Ø¨Ù„", "Ø¨Ø­Ø±", "Ù‚Ù…Ø±", "Ø´Ù…Ø³", "Ù†Ù‡Ø±", "ØµØ­Ø±Ø§Ø¡", "Ø·ÙŠØ§Ø±Ø©", "Ø³ÙŠØ§Ø±Ø©", "Ø­ØµØ§Ù†", "Ù‚Ø·Ø§Ø±", "ÙƒÙ…Ø¨ÙŠÙˆØªØ±", "Ø¬ÙˆØ§Ù„",
    "Ù…Ø¯ÙŠÙ†Ø©", "Ù‚Ø±ÙŠØ©", "Ø´Ø§Ø±Ø¹", "Ù…Ø¯Ø±Ø³Ø©", "Ø¬Ø§Ù…Ø¹Ø©", "Ù…Ø³ØªØ´ÙÙ‰", "ÙƒØªØ§Ø¨", "Ù‚Ù„Ù…", "ÙƒÙˆØ¨", "Ø³Ø§Ø¹Ø©", "Ø´Ø¨Ø§Ùƒ", "Ø¨Ø§Ø¨",
    "Ù†Ø§Ø±", "Ø«Ù„Ø¬", "Ù…Ø·Ø±", "Ø±ÙŠØ­", "ØºÙŠÙ…Ø©", "Ø¸Ù„Ø§Ù„", "Ø¶ÙˆØ¡", "Ø¸Ù„Ø§Ù…", "Ø£Ù…Ù„", "Ø­Ø¨", "ØµØ¯Ø§Ù‚Ø©", "Ø¹Ø¯Ùˆ", "Ù‚ÙˆØ©", "Ø¶Ø¹Ù",
    "Ø¹Ù„Ù…", "Ø¬Ù‡Ù„", "Ø³Ø±", "Ø­Ù‚ÙŠÙ‚Ø©", "Ø®Ø¯Ø§Ø¹", "Ù†ÙØ§Ù‚", "Ø¥Ø®Ù„Ø§Øµ", "Ø®ÙˆÙ", "Ø´Ø¬Ø§Ø¹Ø©", "Ø£Ù…Ù†", "Ø­Ø±Ø¨", "Ø³Ù„Ø§Ù…", "Ø³ÙŠØ§Ø³Ø©",
    "Ø§Ù‚ØªØµØ§Ø¯", "Ù†ÙØ·", "Ø°Ù‡Ø¨", "ÙØ¶Ø©", "Ø­Ø¯ÙŠØ¯", "ØªØ±Ø§Ø¨", "Ù…Ø§Ø¡", "Ù‡ÙˆØ§Ø¡", "Ø®Ø´Ø¨", "Ø²Ø¬Ø§Ø¬", "Ù…Ù„Ø­", "Ø³ÙƒØ±", "ÙÙ„ÙÙ„",
    "Ø®Ø¨Ø²", "Ø£Ø±Ø²", "ØªÙØ§Ø­", "Ù…ÙˆØ²", "Ø¨Ø±ØªÙ‚Ø§Ù„", "Ø¹Ù†Ø¨", "ØªÙˆØª", "Ù„ÙŠÙ…ÙˆÙ†", "Ø¨Ø·ÙŠØ®", "ØªÙ…Ø±", "Ø¬Ø²Ø±", "Ø·Ù…Ø§Ø·Ù…", "Ø¨ØµÙ„",
    "Ø«ÙˆÙ…", "Ø®ÙŠØ§Ø±", "Ù‚Ø±Ø¹", "Ù…Ø·Ø¨Ø®", "Ø­Ù…Ø§Ù…", "ØºØ±ÙØ©", "Ø¨ÙŠØª", "Ù‚ØµØ±", "ÙƒÙˆØ®", "Ù…Ø¹Ø¨Ø¯", "ÙƒÙ†ÙŠØ³Ø©", "Ù…Ø³Ø¬Ø¯", "Ø³ÙˆÙ‚",
    "Ù…ÙˆÙ„", "Ù…Ø·Ø¹Ù…", "Ù…Ù‚Ù‡Ù‰", "Ù…Ø·Ø§Ø±", "Ù…ÙŠÙ†Ø§Ø¡", "Ù…Ø­Ø·Ø©", "Ø¨Ù†Ùƒ", "Ù…ÙƒØªØ¨", "Ù…ØµÙ†Ø¹", "Ù…Ø²Ø±Ø¹Ø©", "Ø­Ø¯ÙŠÙ‚Ø©", "ØºØ§Ø¨Ø©",
    "Ø´Ø§Ø·Ø¦", "Ø³ÙÙŠÙ†Ø©", "Ø¨Ø§Ø®Ø±Ø©", "ØºÙˆØ§ØµØ©", "Ø¯Ø¨Ø§Ø¨Ø©", "Ù…Ø³Ø¯Ø³", "Ø¨Ù†Ø¯Ù‚ÙŠØ©", "Ø³ÙŠÙ", "Ø±Ù…Ø­", "Ø¯Ø±Ø¹", "Ø®ÙˆØ°Ø©", "Ø¬ÙŠØ´",
    "Ø´Ø±Ø·Ø©", "Ø­Ø§Ø±Ø³", "Ù„Øµ", "Ù‚Ø§ØªÙ„", "Ø³Ø§Ø­Ø±", "Ø´Ø§Ø¹Ø±", "ÙƒØ§ØªØ¨", "Ø±Ø³Ø§Ù…", "ÙÙ†Ø§Ù†", "Ù…ÙˆØ³ÙŠÙ‚ÙŠ", "Ù…Ø·Ø±Ø¨", "Ù…Ù…Ø«Ù‘Ù„",
    "Ø±ÙŠØ§Ø¶ÙŠ", "Ù„Ø§Ø¹Ø¨", "Ù…Ø¯Ø±Ø¨", "Ø­ÙƒÙ…", "Ù…Ø´Ø¬Ø¹", "Ø³Ø¨Ø§Ù‚", "Ù…Ø¨Ø§Ø±Ø§Ø©", "Ø¨Ø·ÙˆÙ„Ø©", "ÙƒØ£Ø³", "Ù…ÙŠØ¯Ø§Ù„ÙŠØ©", "ÙƒØ±Ø©", "Ø´Ø¨ÙƒØ©",
    "Ù‚ÙØ§Ø²", "Ø®ÙˆØ°Ø©", "Ù†Ø¸Ø§Ø±Ø©", "Ø³Ù…Ø§Ø¹Ø©", "Ø­Ø°Ø§Ø¡", "Ø¬Ø§ÙƒÙŠØª", "Ù‚Ù…ÙŠØµ", "Ø¨Ù†Ø·Ù„ÙˆÙ†", "ØªÙ†ÙˆØ±Ø©", "ÙØ³ØªØ§Ù†", "Ø¨Ø¯Ù„Ø©", "Ø­Ø²Ø§Ù…",
    "Ø´Ù†Ø·Ø©", "Ù…ÙØªØ§Ø­", "Ù…Ù‚Øµ", "Ù…Ø·Ø±Ù‚Ø©", "Ù…Ø³Ù…Ø§Ø±", "Ù…Ø¨Ø±Ø¯", "Ù…Ù†Ø´Ø§Ø±", "ÙƒÙ…Ø§Ø´Ø©", "Ù…ØºÙ†Ø§Ø·ÙŠØ³", "Ø¨Ø·Ø§Ø±ÙŠØ©", "Ù…ØµØ¨Ø§Ø­",
    "ÙƒØ§Ù…ÙŠØ±Ø§", "ØªÙ„ÙØ§Ø²", "Ø±Ø§Ø¯ÙŠÙˆ", "Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†", "Ù„ÙˆØ­Ø©", "Ø®Ø±ÙŠØ·Ø©", "Ø³Ø§Ø¹Ø© Ø­Ø§Ø¦Ø·", "Ù…Ø±ÙˆØ­Ø©", "Ù…ÙƒÙŠÙ", "Ø«Ù„Ø§Ø¬Ø©",
    "ÙØ±Ù†", "Ù…ÙˆÙ‚Ø¯", "ØºÙ„Ø§ÙŠØ©", "Ù‚Ø¯Ø±", "Ù…Ù„Ø¹Ù‚Ø©", "Ø´ÙˆÙƒØ©", "Ø³ÙƒÙŠÙ†", "ØµØ­Ù†", "ÙƒØ£Ø³ Ù…Ø§Ø¡", "Ø²Ø¨Ø¯ÙŠØ©", "ØµÙŠÙ†ÙŠØ©",
    "ÙƒÙ†Ø¨Ø©", "ÙƒØ±Ø³ÙŠ", "Ø·Ø§ÙˆÙ„Ø©", "Ø¯ÙˆÙ„Ø§Ø¨", "Ù…Ø±Ø¢Ø©", "Ø³Ø¬Ø§Ø¯Ø©", "Ø³ØªØ§Ø±Ø©", "ÙˆØ³Ø§Ø¯Ø©", "Ø¨Ø·Ø§Ù†ÙŠØ©", "Ù…Ø±ØªØ¨Ø©",
    "Ø²Ø±", "Ø­Ø¨Ù„", "Ø´Ø±ÙŠØ·", "ØµÙ†Ø¯ÙˆÙ‚", "Ø¹Ù„Ø¨Ø©", "Ø¯Ø¨ÙˆØ³", "Ù…Ø´Ø¨Ùƒ", "Ù‚ÙÙ„", "Ø³Ù„Ø³Ù„Ø©", "Ø¥Ø·Ø§Ø±",
    "Ø¯Ø±Ø¬", "Ù…Ù…Ø±", "Ø³Ø·Ø­", "Ù‚Ø¨Ùˆ", "Ø­Ø¯ÙŠÙ‚Ø© Ù…Ù†Ø²Ù„ÙŠØ©", "Ù…Ø±Ø¢Ø¨", "Ø¨ÙˆØ§Ø¨Ø©", "Ù…Ø¯Ø®Ù„", "Ù…Ø®Ø±Ø¬", "Ø±ÙˆØ§Ù‚",
    "Ø«Ø±ÙŠØ§", "Ø´Ù…Ø¹Ø©", "Ù…ØµØ¨Ø§Ø­ ÙŠØ¯ÙˆÙŠ", "ÙˆÙ„Ø§Ø¹Ø©", "ÙˆÙ„Ø§Ø¹Ø© ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©", "Ù…ØµØ¨Ø§Ø­ Ù…ÙƒØªØ¨", "Ø¶ÙˆØ¡ Ù†ÙŠÙˆÙ†", "ÙƒØ´Ø§Ù",
  ];

  // Ø£Ø²Ø±Ø§Ø± ÙˆØ¹Ù†Ø§ØµØ±
  const roomScreen = document.getElementById("roomScreen");
  const roleScreen = document.getElementById("roleScreen");
  const gameScreen = document.getElementById("gameScreen");

  const roomNameInput = document.getElementById("roomName");
  const roomPassInput = document.getElementById("roomPass");
  const createBtn = document.getElementById("createBtn");
  const joinBtn = document.getElementById("joinBtn");
  const errorDiv = document.getElementById("error");

  const playerNameInput = document.getElementById("playerName");
  const rolesDiv = document.getElementById("roles");
  const joinGameBtn = document.getElementById("joinGame");
  const roleErrorDiv = document.getElementById("roleError");

  const infoDiv = document.getElementById("info");
  const playersListDiv = document.getElementById("playersList");
  const boardDiv = document.getElementById("board");
  const passBtn = document.getElementById("pass");
  const restartBtn = document.getElementById("restart");
  const leaveBtn = document.getElementById("leave");

  // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø©
  let currentRoom = null;
  let currentPass = null;
  let players = {};
  let board = [];
  let turn = "red";
  let redLeft = 9;
  let blueLeft = 8;
  let gameEnded = false;
  let playerId = null;
  let playerRole = null;
  let playerName = null;

  // Ø§Ø®ØªÙŠØ§Ø± Ø¯ÙˆØ±
  rolesDiv.addEventListener("click", e => {
    if(!e.target.classList.contains("role")) return;
    [...rolesDiv.children].forEach(r => r.classList.remove("selected"));
    e.target.classList.add("selected");
    playerRole = e.target.dataset.role;
  });

  // Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ©
  createBtn.onclick = async () => {
    errorDiv.textContent = "";
    const room = roomNameInput.value.trim();
    const pass = roomPassInput.value.trim();
    if(!room) return errorDiv.textContent = "Ù„Ø§Ø²Ù… ØªÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„ØºØ±ÙØ©.";
    if(!pass) return errorDiv.textContent = "Ù„Ø§Ø²Ù… ØªÙƒØªØ¨ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±.";

    const roomRef = db.ref("rooms/" + room);
    const snapshot = await roomRef.get();
    if(snapshot.exists()){
      errorDiv.textContent = "Ø§Ù„ØºØ±ÙØ© Ù…ÙˆØ¬ÙˆØ¯Ø©ØŒ Ø§Ø³ØªØ®Ø¯Ù… 'Ø§Ø¯Ø®Ù„ Ø§Ù„ØºØ±ÙØ©'.";
      return;
    }

    // Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØºØ±ÙØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    await roomRef.set({
      pass,
      players: {},
      board: [],
      turn: "red",
      redLeft: 9,
      blueLeft: 8,
      gameEnded: false,
    });

    currentRoom = room;
    currentPass = pass;

    showRoleScreen();
  };

  // Ø¯Ø®ÙˆÙ„ ØºØ±ÙØ©
  joinBtn.onclick = async () => {
    errorDiv.textContent = "";
    const room = roomNameInput.value.trim();
    const pass = roomPassInput.value.trim();
    if(!room) return errorDiv.textContent = "Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„ØºØ±ÙØ©.";
    if(!pass) return errorDiv.textContent = "Ø§ÙƒØªØ¨ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±.";

    const roomRef = db.ref("rooms/" + room);
    const snapshot = await roomRef.get();
    if(!snapshot.exists()){
      errorDiv.textContent = "Ø§Ù„ØºØ±ÙØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©.";
      return;
    }

    const data = snapshot.val();
    if(data.pass !== pass){
      errorDiv.textContent = "ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø®Ø§Ø·Ø¦Ø©.";
      return;
    }

    currentRoom = room;
    currentPass = pass;

    showRoleScreen();
  };

  // Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ø¹Ø¨Ø© Ø¨Ø¹Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø¯ÙˆØ±
  joinGameBtn.onclick = async () => {
    roleErrorDiv.textContent = "";
    playerName = playerNameInput.value.trim();
    if(!playerName) return roleErrorDiv.textContent = "Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ.";
    if(!playerRole) return roleErrorDiv.textContent = "Ø§Ø®ØªØ§Ø± Ø¯ÙˆØ±Ùƒ.";

    playerId = generateId();

    const playerData = {
      name: playerName,
      role: playerRole,
      id: playerId,
      score: 0
    };

    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù„Ù„ØºØ±ÙØ© ÙÙŠ Ø§Ù„ÙØ§ÙŠØ±Ø¨ÙŠØ³
    const playerRef = db.ref(`rooms/${currentRoom}/players/${playerId}`);
    await playerRef.set(playerData);

    subscribeToRoom();

    showGameScreen();
  };

  // ØªÙˆÙ„ÙŠØ¯ Ù…Ø¹Ø±Ù‘Ù Ø¹Ø´ÙˆØ§Ø¦ÙŠ
  function generateId(){
    return Math.random().toString(36).substr(2,9);
  }

  // Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØºØ±ÙØ©
  let unsubscribe = null;
  function subscribeToRoom(){
    if(unsubscribe) unsubscribe();
    const roomRef = db.ref("rooms/" + currentRoom);
    unsubscribe = roomRef.on("value", snapshot => {
      if(!snapshot.exists()) return;
      const data = snapshot.val();

      // ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±
      if(data.pass !== currentPass){
        alert("ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø£Ùˆ ØªÙ… Ø­Ø°Ù Ø§Ù„ØºØ±ÙØ©.");
        leaveRoom();
        return;
      }

      players = data.players || {};
      board = data.board || [];
      turn = data.turn || "red";
      redLeft = data.redLeft ?? 9;
      blueLeft = data.blueLeft ?? 8;
      gameEnded = data.gameEnded || false;

      updateGameUI();
    });
  }

  // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©
  function updateGameUI(){
    // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¯ÙˆØ± ÙˆØ§Ù„Ù„Ø§Ø¹Ø¨
    infoDiv.textContent = `Ø¯ÙˆØ±: ${turn === "red" ? "Ø§Ù„Ø£Ø­Ù…Ø±" : "Ø§Ù„Ø£Ø²Ø±Ù‚"} | Ø£Ù†Øª: ${playerName} (${playerRole})`;

    // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†
    playersListDiv.innerHTML = "";
    Object.values(players).forEach(p => {
      const div = document.createElement("div");
      div.textContent = p.name + (p.id === playerId ? " (Ø£Ù†Øª)" : "");
      div.classList.add("playerCard");
      div.classList.add(p.role);
      playersListDiv.appendChild(div);
    });

    // Ø¹Ø±Ø¶ Ø§Ù„Ù„ÙˆØ­Ø©
    boardDiv.innerHTML = "";
    board.forEach((card, i) => {
      const cardDiv = document.createElement("div");
      cardDiv.classList.add("card");
      if(card.revealed) cardDiv.classList.add("revealed");

      if(card.type === "red") cardDiv.classList.add("red");
      else if(card.type === "blue") cardDiv.classList.add("blue");
      else if(card.type === "neutral") cardDiv.classList.add("neutral");
      else if(card.type === "assassin") cardDiv.classList.add("assassin");

      cardDiv.textContent = card.word;
      boardDiv.appendChild(cardDiv);

      if(!card.revealed && !gameEnded && playerRole !== "spy"){
        cardDiv.onclick = () => {
          if(turn !== playerRole) return;
          revealCard(i);
        };
      }
    });

    passBtn.disabled = playerRole !== "spy" || gameEnded;
    restartBtn.disabled = !gameEnded && playerRole !== "spy";
  }

  // ÙƒØ´Ù Ø¨Ø·Ø§Ù‚Ø©
  async function revealCard(index){
    if(gameEnded) return;

    const card = board[index];
    if(card.revealed) return;

    card.revealed = true;

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¯ Ø­Ø³Ø¨ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
    if(card.type === "red") redLeft--;
    else if(card.type === "blue") blueLeft--;

    // ØªØºÙŠÙŠØ± Ø§Ù„Ø¯ÙˆØ± Ø£Ùˆ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©
    if(card.type === "assassin"){
      gameEnded = true;
      alert(`Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø©! Ø§Ù„Ø®Ø§Ø³Ø± Ù‡Ùˆ ÙØ±ÙŠÙ‚ ${turn === "red" ? "Ø§Ù„Ø£Ø­Ù…Ø±" : "Ø§Ù„Ø£Ø²Ø±Ù‚"}`);
    } else if(redLeft === 0){
      gameEnded = true;
      alert("Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø©! Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø­Ù…Ø± ÙØ§Ø² ğŸ‰");
    } else if(blueLeft === 0){
      gameEnded = true;
      alert("Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø©! Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø²Ø±Ù‚ ÙØ§Ø² ğŸ‰");
    } else if(card.type !== turn){
      turn = turn === "red" ? "blue" : "red";
    }

    // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØºØ±ÙØ©
    const roomRef = db.ref("rooms/" + currentRoom);
    await roomRef.update({
      board,
      turn,
      redLeft,
      blueLeft,
      gameEnded
    });
  }

  // ØªØºÙŠÙŠØ± Ø§Ù„Ø¯ÙˆØ± (Ù„ÙƒÙ„ Ø³Ø¨Ø§ÙŠ Ù…Ø§Ø³ØªØ± ÙÙ‚Ø·)
  passBtn.onclick = async () => {
    if(playerRole !== "spy") return;
    if(gameEnded) return;

    turn = turn === "red" ? "blue" : "red";
    const roomRef = db.ref("rooms/" + currentRoom);
    await roomRef.update({ turn });
  };

  // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© (Ù„ÙƒÙ„ Ø³Ø¨Ø§ÙŠ Ù…Ø§Ø³ØªØ± ÙÙ‚Ø·)
  restartBtn.onclick = async () => {
    if(playerRole !== "spy") return;

    // Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©
    board = generateBoard();
    turn = "red";
    redLeft = 9;
    blueLeft = 8;
    gameEnded = false;

    const roomRef = db.ref("rooms/" + currentRoom);
    await roomRef.update({
      board,
      turn,
      redLeft,
      blueLeft,
      gameEnded
    });
  };

  // Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„ØºØ±ÙØ©
  leaveBtn.onclick = () => {
    leaveRoom();
  };

  // ØªØ±Ùƒ Ø§Ù„ØºØ±ÙØ© ÙˆØªÙ†Ø¸ÙŠÙ
  async function leaveRoom(){
    if(unsubscribe) unsubscribe();
    if(playerId){
      const playerRef = db.ref(`rooms/${currentRoom}/players/${playerId}`);
      await playerRef.remove();
    }
    currentRoom = null;
    currentPass = null;
    playerRole = null;
    playerName = null;
    playerId = null;
    players = {};
    board = [];
    gameEnded = false;
    turn = "red";
    redLeft = 9;
    blueLeft = 8;

    roleScreen.classList.add("hidden");
    gameScreen.classList.add("hidden");
    roomScreen.classList.remove("hidden");
  }

  // Ø¹Ø±Ø¶ Ø´Ø§Ø´Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø¯ÙˆØ±
  function showRoleScreen(){
    roomScreen.classList.add("hidden");
    roleScreen.classList.remove("hidden");
    gameScreen.classList.add("hidden");
  }

  // Ø¹Ø±Ø¶ Ø´Ø§Ø´Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©
  function showGameScreen(){
    roomScreen.classList.add("hidden");
    roleScreen.classList.add("hidden");
    gameScreen.classList.remove("hidden");
  }

  // Ø¥Ù†Ø´Ø§Ø¡ Ù„ÙˆØ­Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
  function generateBoard(){
    // Ø§Ø®ØªÙŠØ§Ø± 25 ÙƒÙ„Ù…Ø© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© Ø¨Ø¯ÙˆÙ† ØªÙƒØ±Ø§Ø±
    const shuffled = wordsPool.sort(() => 0.5 - Math.random());
    const selectedWords = shuffled.slice(0, 25);

    // ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£Ø¯ÙˆØ§Ø± Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ„Ù…Ø§Øª
    const types = [];
    for(let i=0; i<9; i++) types.push("red");
    for(let i=0; i<8; i++) types.push("blue");
    for(let i=0; i<7; i++) types.push("neutral");
    types.push("assassin");

    // Ø®Ù„Ø· Ø§Ù„Ø£Ø¯ÙˆØ§Ø±
    types.sort(() => 0.5 - Math.random());

    // Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù„ÙˆØ­Ø©
    const board = selectedWords.map((word, i) => ({
      word,
      type: types[i],
      revealed: false,
    }));
    return board;
  }
  </script>
</body>
</html>
