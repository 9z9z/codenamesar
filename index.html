<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Codenames Online - كود نايمز</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Arial, sans-serif;
      background: linear-gradient(135deg, #1a2a6c 0%, #b21f1f 100%);
      min-height: 100vh;
      color: #fff;
      overflow-x: hidden;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      text-align: center;
      margin-bottom: 2rem;
      animation: fadeInDown 0.8s ease-out;
    }

    .header h1 {
      font-size: 3rem;
      font-weight: 700;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
      margin-bottom: 0.5rem;
      background: linear-gradient(45deg, #ffd700, #ff8c00);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .header p {
      font-size: 1.2rem;
      opacity: 0.9;
      margin-top: 10px;
    }

    .game-container {
      display: grid;
      grid-template-columns: 1fr 350px;
      gap: 2rem;
      margin-bottom: 2rem;
    }

    .main-game {
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 2rem;
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 8px 32px rgba(0,0,0,0.2);
    }

    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .panel {
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 1.5rem;
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 8px 32px rgba(0,0,0,0.2);
    }

    .panel h3 {
      margin-bottom: 1rem;
      color: #ffd700;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
      border-bottom: 2px solid rgba(255, 215, 0, 0.5);
      padding-bottom: 10px;
    }

    .form-group {
      margin-bottom: 1.2rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: #ffd700;
    }

    .form-group input, .form-group select {
      width: 100%;
      padding: 0.75rem;
      border: none;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.9);
      color: #333;
      font-size: 1rem;
      transition: all 0.3s ease;
      border: 2px solid transparent;
    }

    .form-group input:focus, .form-group select:focus {
      outline: none;
      background: rgba(255, 255, 255, 1);
      box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.5);
      border-color: #ffd700;
    }

    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 10px;
      background: linear-gradient(45deg, #ff8c00, #ff4500);
      color: white;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      letter-spacing: 0.5px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.2);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn-primary {
      background: linear-gradient(45deg, #4CAF50, #2E8B57);
    }

    .btn-secondary {
      background: linear-gradient(45deg, #2196F3, #1E90FF);
    }

    .btn-danger {
      background: linear-gradient(45deg, #f44336, #B22222);
    }

    .game-board {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 10px;
      margin: 2rem 0;
    }

    .card {
      aspect-ratio: 1.5;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 1rem;
      color: #333;
      cursor: pointer;
      transition: all 0.3s ease;
      user-select: none;
      border: 2px solid transparent;
      position: relative;
      overflow: hidden;
      text-align: center;
      padding: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 16px rgba(0,0,0,0.2);
    }

    .card.red {
      background: linear-gradient(135deg, #ff6b6b, #c00000);
      color: white;
      border-color: #ff4757;
    }

    .card.blue {
      background: linear-gradient(135deg, #4834d4, #000080);
      color: white;
      border-color: #3742fa;
    }

    .card.neutral {
      background: linear-gradient(135deg, #a4b0be, #556677);
      color: white;
      border-color: #57606f;
    }

    .card.assassin {
      background: linear-gradient(135deg, #2c2c54, #000000);
      color: #ff3838;
      border-color: #ff3838;
      box-shadow: 0 0 20px rgba(255, 56, 56, 0.5);
    }

    .card.guessed {
      opacity: 0.7;
      transform: scale(0.95);
      cursor: default;
    }

    .card.guessed::after {
      content: '✓';
      position: absolute;
      top: 5px;
      right: 5px;
      font-size: 1.5rem;
      color: #fff;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
    }

    .game-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      padding: 1rem;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .team-score {
      text-align: center;
      padding: 10px 20px;
      border-radius: 10px;
      background: rgba(0, 0, 0, 0.2);
      min-width: 120px;
    }

    .team-score .score {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }

    .team-score.red .score {
      color: #ff6b6b;
      text-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
    }

    .team-score.blue .score {
      color: #6a5acd;
      text-shadow: 0 0 10px rgba(0, 0, 255, 0.5);
    }

    .turn-indicator {
      font-size: 1.3rem;
      font-weight: 600;
      padding: 0.8rem 1.5rem;
      border-radius: 20px;
      background: rgba(255, 255, 255, 0.2);
      min-width: 200px;
      text-align: center;
      border: 2px solid rgba(255, 215, 0, 0.5);
    }

    .chat-container {
      height: 300px;
      display: flex;
      flex-direction: column;
    }

    .chat-messages {
      flex: 1;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 10px;
      padding: 1rem;
      overflow-y: auto;
      margin-bottom: 1rem;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .chat-message {
      padding: 0.8rem;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.1);
      border-left: 3px solid #ffd700;
    }

    .chat-message .username {
      font-weight: 600;
      color: #ffd700;
      margin-bottom: 3px;
    }

    .chat-message .time {
      font-size: 0.8rem;
      opacity: 0.7;
      margin-left: 10px;
    }

    .chat-input {
      display: flex;
      gap: 0.5rem;
    }

    .chat-input input {
      flex: 1;
      padding: 0.75rem;
      border: none;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.9);
      color: #333;
      border: 2px solid transparent;
    }

    .chat-input input:focus {
      outline: none;
      border-color: #ffd700;
      box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.3);
    }

    .players-list {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 10px;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .player-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.8rem;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      border-left: 3px solid #ffd700;
    }

    .player-role {
      font-size: 0.85rem;
      padding: 0.3rem 0.6rem;
      border-radius: 10px;
      background: rgba(255, 215, 0, 0.2);
    }

    .controls {
      display: flex;
      gap: 1rem;
      margin-top: 1.5rem;
      flex-wrap: wrap;
    }

    .winner-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .winner-content {
      background: linear-gradient(135deg, #1a2a6c, #b21f1f);
      padding: 3rem;
      border-radius: 20px;
      text-align: center;
      color: white;
      max-width: 500px;
      width: 90%;
      border: 3px solid #ffd700;
      box-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
    }

    .winner-content h2 {
      font-size: 2.5rem;
      margin-bottom: 1.5rem;
      color: #ffd700;
    }

    .winner-content p {
      font-size: 1.2rem;
      margin-bottom: 2rem;
    }

    .hidden {
      display: none;
    }

    .lobby-screen {
      text-align: center;
      padding: 2rem;
      max-width: 600px;
      margin: 0 auto;
    }

    .lobby-screen .btn {
      margin: 0.5rem;
      min-width: 200px;
    }
    
    .loading {
      text-align: center;
      padding: 2rem;
      font-size: 1.2rem;
    }
    
    .loading-spinner {
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid #ffd700;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }
    
    .error-message {
      background: #ff6b6b;
      color: white;
      padding: 12px;
      border-radius: 8px;
      margin: 15px 0;
      text-align: center;
      font-weight: 600;
    }

    .room-code-display {
      font-size: 1.5rem;
      margin: 15px 0;
      padding: 10px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 10px;
      border: 2px dashed #ffd700;
    }

    @keyframes fadeInDown {
      from {
        opacity: 0;
        transform: translateY(-30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes pulse {
      0% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.05);
      }
      100% {
        transform: scale(1);
      }
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .card.highlight {
      animation: pulse 0.5s ease-in-out 2;
    }

    @media (max-width: 768px) {
      .game-container {
        grid-template-columns: 1fr;
      }
      
      .header h1 {
        font-size: 2.2rem;
      }
      
      .game-board {
        grid-template-columns: repeat(5, 1fr);
        gap: 6px;
      }
      
      .card {
        font-size: 0.85rem;
        padding: 5px;
      }
      
      .controls {
        flex-direction: column;
      }
      
      .game-info {
        flex-direction: column;
        gap: 15px;
      }
      
      .team-score {
        width: 100%;
      }
    }
  </style>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>🎯 كود نايمز أونلاين</h1>
      <p>لعبة التخمين والذكاء الجماعية - العب مع أصدقائك في الوقت الحقيقي</p>
    </div>

    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading hidden">
      <div class="loading-spinner"></div>
      <p>جاري تحميل اللعبة...</p>
    </div>

    <!-- Lobby Screen -->
    <div id="lobbyScreen" class="lobby-screen">
      <div class="panel">
        <h3>انضم إلى اللعبة</h3>
        <div id="errorContainer"></div>
        <div class="form-group">
          <label for="playerName">اسم اللاعب:</label>
          <input type="text" id="playerName" placeholder="أدخل اسمك" value="اللاعب">
        </div>
        <div class="form-group">
          <label for="roomCode">كود الغرفة:</label>
          <input type="text" id="roomCode" placeholder="أدخل كود الغرفة">
        </div>
        <div class="form-group">
          <label for="playerRole">دورك في اللعبة:</label>
          <select id="playerRole">
            <option value="field_red">عميل ميداني - الفريق الأحمر</option>
            <option value="spy_red">رئيس الجواسيس - الفريق الأحمر</option>
            <option value="field_blue">عميل ميداني - الفريق الأزرق</option>
            <option value="spy_blue">رئيس الجواسيس - الفريق الأزرق</option>
          </select>
        </div>
        <button class="btn btn-primary" id="joinGameBtn">انضم إلى اللعبة</button>
        <button class="btn btn-secondary" id="createRoomBtn">إنشاء غرفة جديدة</button>
        <div id="roomCodeDisplay" class="room-code-display hidden"></div>
      </div>
    </div>

    <!-- Game Screen -->
    <div id="gameScreen" class="game-container hidden">
      <div class="main-game">
        <div class="game-info">
          <div class="team-score red">
            <div class="score" id="redScore">9</div>
            <div>الفريق الأحمر</div>
          </div>
          <div class="turn-indicator" id="turnIndicator">
            دور الفريق الأحمر
          </div>
          <div class="team-score blue">
            <div class="score" id="blueScore">8</div>
            <div>الفريق الأزرق</div>
          </div>
        </div>
        
        <div class="game-board" id="gameBoard">
          <!-- Cards will be generated here -->
        </div>
        
        <div class="controls">
          <button class="btn btn-secondary" id="spymasterBtn">
            تشغيل وضع رئيس الجواسيس
          </button>
          <button class="btn btn-danger" id="passTurnBtn">
            تمرير الدور
          </button>
          <button class="btn btn-primary" id="newGameBtn">
            لعبة جديدة
          </button>
        </div>
      </div>

      <div class="sidebar">
        <div class="panel">
          <h3>اللاعبون (<span id="playersCount">0</span>)</h3>
          <div class="players-list" id="playersList">
            <!-- Players will be listed here -->
          </div>
        </div>

        <div class="panel">
          <h3>الدردشة</h3>
          <div class="chat-container">
            <div class="chat-messages" id="chatMessages">
              <!-- Chat messages will appear here -->
            </div>
            <div class="chat-input">
              <input type="text" id="chatInput" placeholder="اكتب رسالة...">
              <button class="btn" id="sendMessageBtn">إرسال</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Winner Modal -->
    <div id="winnerModal" class="winner-modal hidden">
      <div class="winner-content">
        <h2 id="winnerText">🎉 الفريق الأحمر يفوز!</h2>
        <p>تهانينا على الفوز! لقد أثبتم مهارتكم في التخمين والاستراتيجية</p>
        <div class="controls" style="justify-content: center; margin-top: 30px;">
          <button class="btn btn-primary" id="closeWinnerBtn">إغلاق</button>
          <button class="btn btn-secondary" id="newGameModalBtn">لعبة جديدة</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDTAqaqpmPX0JYie21Gl2ysp1mHgKuw2EY",
      authDomain: "myupload-948bd.firebaseapp.com",
      projectId: "myupload-948bd",
      storageBucket: "myupload-948bd.appspot.com",
      messagingSenderId: "451397571101",
      appId: "1:451397571101:web:90b7cf96637819f734ecf4"
    };

    // Initialize Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // Game state
    let gameState = {
      players: {},
      cards: [],
      currentTurn: 'red',
      redScore: 9,
      blueScore: 8,
      winner: null,
      currentPlayer: null,
      roomCode: null,
      playerId: null,
      playerRole: null,
      isRoomCreator: false
    };

    // Local state for spymaster mode
    let spymasterMode = false;

    // Sample Arabic words for the game
const arabicWords = [
  'شمس', 'قمر', 'نجم', 'بحر', 'جبل', 'نهر', 'شجرة', 'وردة', 'طائر', 'قط',
  'كلب', 'حصان', 'سيارة', 'طائرة', 'قطار', 'بيت', 'مدرسة', 'مسجد', 'مكتبة', 'سوق',
  'طبيب', 'مهندس', 'معلم', 'طباخ', 'رسام', 'كتاب', 'قلم', 'ورقة', 'حاسوب', 'هاتف',
  'تلفاز', 'راديو', 'موسيقى', 'فيلم', 'لعبة', 'كرة', 'ملعب', 'حديقة', 'مقهى', 'مطعم',
  'خبز', 'ماء', 'شاي', 'قهوة', 'عسل', 'تفاح', 'برتقال', 'موز', 'عنب', 'فراولة',
  'قصر', 'مدينة', 'قرية', 'شاطئ', 'نار', 'ريح', 'ثلج', 'غيمة', 'صقر', 'نمر',
  'فيل', 'دب', 'قطة', 'حصان', 'بحيرة', 'بركان', 'صحراء', 'غابة', 'زرع', 'حصى',
  'لؤلؤ', 'مطر', 'كهرباء', 'ذهب', 'فضة', 'برق', 'ريشة', 'قوس', 'نهر', 'صخرة',
  'قارب', 'سفينة', 'هلال', 'سحاب', 'طوفان', 'موجة', 'كنز', 'خاتم', 'سيف', 'دراجة',
  'مروحة', 'بوابة', 'مظلة', 'مصباح', 'مرآة', 'مفتاح', 'ساعة', 'قميص', 'بنطال', 'حذاء',
  'نظارة', 'قبعة', 'حقيبة', 'لوحة', 'قهوة', 'شوكولاتة', 'مطرقة', 'منشار', 'مسمار', 'برغي',
  'قلم رصاص', 'ممحاة', 'دفتر', 'حبل', 'مفتاح سيارة', 'كاميرا', 'ميكروفون', 'مكبر صوت'
];

    // DOM Elements
    const elements = {
      lobbyScreen: document.getElementById('lobbyScreen'),
      gameScreen: document.getElementById('gameScreen'),
      loadingScreen: document.getElementById('loadingScreen'),
      winnerModal: document.getElementById('winnerModal'),
      gameBoard: document.getElementById('gameBoard'),
      playersList: document.getElementById('playersList'),
      chatMessages: document.getElementById('chatMessages'),
      playerName: document.getElementById('playerName'),
      roomCode: document.getElementById('roomCode'),
      playerRole: document.getElementById('playerRole'),
      redScore: document.getElementById('redScore'),
      blueScore: document.getElementById('blueScore'),
      turnIndicator: document.getElementById('turnIndicator'),
      winnerText: document.getElementById('winnerText'),
      errorContainer: document.getElementById('errorContainer'),
      createRoomBtn: document.getElementById('createRoomBtn'),
      joinGameBtn: document.getElementById('joinGameBtn'),
      spymasterBtn: document.getElementById('spymasterBtn'),
      passTurnBtn: document.getElementById('passTurnBtn'),
      newGameBtn: document.getElementById('newGameBtn'),
      newGameModalBtn: document.getElementById('newGameModalBtn'),
      closeWinnerBtn: document.getElementById('closeWinnerBtn'),
      sendMessageBtn: document.getElementById('sendMessageBtn'),
      chatInput: document.getElementById('chatInput'),
      roomCodeDisplay: document.getElementById('roomCodeDisplay'),
      playersCount: document.getElementById('playersCount')
    };

    // Initialize Firebase and game
    function initializeGame() {
      showLoading();
      
      // Generate unique player ID
      gameState.playerId = generatePlayerId();
      
      if (gameState.isRoomCreator) {
        // Room creator - generate cards and set initial state
        generateCards();
        saveGameState();
        addChatMessage('النظام', 'تم إنشاء غرفة جديدة!');
      }
      
      // Listen for game state changes
      database.ref(`rooms/${gameState.roomCode}/state`).on('value', (snapshot) => {
        const state = snapshot.val();
        if (state) {
          gameState.cards = state.cards || [];
          gameState.currentTurn = state.currentTurn || 'red';
          gameState.redScore = state.redScore || 9;
          gameState.blueScore = state.blueScore || 8;
          gameState.winner = state.winner || null;
          
          updateDisplay();
          
          // Show winner if exists
          if (gameState.winner) {
            showWinner();
          }
        }
      });
      
      // Listen for player list changes
      database.ref(`rooms/${gameState.roomCode}/players`).on('value', (snapshot) => {
        const players = snapshot.val();
        if (players) {
          gameState.players = players;
          updatePlayersList();
          elements.playersCount.textContent = Object.keys(players).length;
        }
      });
      
      // Listen for chat messages
      database.ref(`rooms/${gameState.roomCode}/chat`).on('child_added', (snapshot) => {
        const msg = snapshot.val();
        if (msg) {
          addChatMessage(msg.sender, msg.text);
        }
      });
      
      hideLoading();
    }

    // Generate unique player ID
    function generatePlayerId() {
      return 'player_' + Math.random().toString(36).substr(2, 9);
    }

    // Generate random cards
    function generateCards() {
      const shuffledWords = [...arabicWords].sort(() => 0.5 - Math.random()).slice(0, 25);
      const colors = [
        'red', 'red', 'red', 'red', 'red', 'red', 'red', 'red', 'red',
        'blue', 'blue', 'blue', 'blue', 'blue', 'blue', 'blue', 'blue',
        'neutral', 'neutral', 'neutral', 'neutral', 'neutral', 'neutral', 'neutral',
        'assassin'
      ];
      
      // Shuffle colors
      for (let i = colors.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [colors[i], colors[j]] = [colors[j], colors[i]];
      }

      gameState.cards = shuffledWords.map((word, index) => ({
        word: word,
        color: colors[index],
        revealed: false,
        id: index
      }));
    }

    // Save game state to Firebase
    function saveGameState() {
      if (!gameState.roomCode) return;
      
      const stateRef = database.ref(`rooms/${gameState.roomCode}/state`);
      stateRef.set({
        cards: gameState.cards,
        currentTurn: gameState.currentTurn,
        redScore: gameState.redScore,
        blueScore: gameState.blueScore,
        winner: gameState.winner
      });
    }

    // Save player state to Firebase
    function savePlayerState() {
      if (!gameState.roomCode || !gameState.playerId) return;
      
      const playerRef = database.ref(`rooms/${gameState.roomCode}/players/${gameState.playerId}`);
      playerRef.set({
        name: gameState.currentPlayer,
        role: gameState.playerRole,
        team: gameState.playerRole.includes('red') ? 'red' : 'blue',
        type: gameState.playerRole.includes('spy') ? 'spy' : 'field'
      });
    }

    // Create room
    function createRoom() {
      const playerName = elements.playerName.value.trim();
      if (!playerName) {
        showError('يرجى إدخال اسم اللاعب');
        return;
      }
      
      showLoading();
      
      const roomCode = Math.random().toString(36).substring(2, 8).toUpperCase();
      elements.roomCode.value = roomCode;
      gameState.roomCode = roomCode;
      gameState.currentPlayer = playerName;
      gameState.playerRole = elements.playerRole.value;
      gameState.isRoomCreator = true;
      
      // Set current player locally
      gameState.players[gameState.playerId] = {
        name: gameState.currentPlayer,
        role: gameState.playerRole,
        team: gameState.playerRole.includes('red') ? 'red' : 'blue',
        type: gameState.playerRole.includes('spy') ? 'spy' : 'field'
      };
      
      // Show room code
      elements.roomCodeDisplay.textContent = `كود الغرفة: ${roomCode}`;
      elements.roomCodeDisplay.classList.remove('hidden');
      
      // Initialize room in Firebase
      database.ref(`rooms/${roomCode}`).set({
        created: new Date().toISOString()
      }).then(() => {
        savePlayerState();
        elements.lobbyScreen.classList.add('hidden');
        elements.gameScreen.classList.remove('hidden');
        initializeGame();
      }).catch((error) => {
        console.error("Error creating room: ", error);
        hideLoading();
        showError('حدث خطأ أثناء إنشاء الغرفة');
      });
    }

    // Join game
    function joinGame() {
      const playerName = elements.playerName.value.trim();
      const roomCode = elements.roomCode.value.trim().toUpperCase();
      const playerRole = elements.playerRole.value;

      if (!playerName) {
        showError('يرجى إدخال اسم اللاعب');
        return;
      }
      
      if (!roomCode) {
        showError('يرجى إدخال كود الغرفة');
        return;
      }
      
      showLoading();
      
      // Check if room exists
      database.ref(`rooms/${roomCode}`).once('value').then((snapshot) => {
        if (snapshot.exists()) {
          gameState.roomCode = roomCode;
          gameState.currentPlayer = playerName;
          gameState.playerRole = playerRole;
          gameState.isRoomCreator = false;
          
          // Set current player locally
          gameState.players[gameState.playerId] = {
            name: gameState.currentPlayer,
            role: gameState.playerRole,
            team: gameState.playerRole.includes('red') ? 'red' : 'blue',
            type: gameState.playerRole.includes('spy') ? 'spy' : 'field'
          };
          
          savePlayerState();
          elements.lobbyScreen.classList.add('hidden');
          elements.gameScreen.classList.remove('hidden');
          initializeGame();
        } else {
          hideLoading();
          showError('كود الغرفة غير صحيح!');
        }
      }).catch((error) => {
        console.error("Error joining room: ", error);
        hideLoading();
        showError('حدث خطأ أثناء الانضمام للغرفة');
      });
    }

    // Update display
    function updateDisplay() {
      updateBoard();
      updateScores();
      updateTurnIndicator();
      updatePlayersList();
    }

    // Update game board
    function updateBoard() {
      elements.gameBoard.innerHTML = '';

      gameState.cards.forEach(card => {
        const cardElement = document.createElement('div');
        cardElement.className = 'card';
        cardElement.textContent = card.word;
        cardElement.dataset.id = card.id;

        if (card.revealed) {
          cardElement.classList.add('guessed', card.color);
        } else if (spymasterMode && isSpymaster()) {
          cardElement.classList.add(card.color);
          cardElement.style.cursor = 'default';
        } else {
          // Only add click event for unrevealed cards
          cardElement.addEventListener('click', () => selectCard(card.id));
        }

        elements.gameBoard.appendChild(cardElement);
      });
    }

    // Select card
    function selectCard(cardId) {
      const card = gameState.cards[cardId];
      if (card.revealed || gameState.winner) return;

      const currentPlayer = gameState.players[gameState.playerId];
      if (!currentPlayer) return;

      // Only field operatives can select cards
      if (currentPlayer.type === 'spy') {
        showError('رئيس الجواسيس لا يمكنه اختيار البطاقات');
        return;
      }

      // Check if it's the player's team turn
      if (currentPlayer.team !== gameState.currentTurn) {
        showError('ليس دور فريقك');
        return;
      }

      card.revealed = true;
      
      // Add highlight effect
      const cardElement = document.querySelector(`.card[data-id="${cardId}"]`);
      if (cardElement) {
        cardElement.classList.add('highlight');
      }

      // Check card type and handle accordingly
      if (card.color === 'assassin') {
        gameState.winner = currentPlayer.team === 'red' ? 'blue' : 'red';
        addChatMessage('النظام', `💀 تم اختيار بطاقة القاتل! فاز الفريق ${gameState.winner === 'red' ? 'الأحمر' : 'الأزرق'}`);
        showWinner();
      } else if (card.color === currentPlayer.team) {
        // Correct team card
        if (currentPlayer.team === 'red') {
          gameState.redScore--;
        } else {
          gameState.blueScore--;
        }
        addChatMessage('النظام', `✅ ${currentPlayer.name} اختار بطاقة صحيحة: ${card.word}`);
        
        // Check for win
        if (gameState.redScore === 0) {
          gameState.winner = 'red';
          showWinner();
        } else if (gameState.blueScore === 0) {
          gameState.winner = 'blue';
          showWinner();
        }
      } else {
        // Wrong team card or neutral
        addChatMessage('النظام', `❌ ${currentPlayer.name} اختار بطاقة خاطئة: ${card.word}`);
        switchTurn();
      }

      saveGameState();
      updateDisplay();
    }

    // Switch turn
    function switchTurn() {
      gameState.currentTurn = gameState.currentTurn === 'red' ? 'blue' : 'red';
      saveGameState();
    }

    // Toggle spymaster mode
    function toggleSpymaster() {
      const currentPlayer = gameState.players[gameState.playerId];
      if (!currentPlayer) return;

      if (currentPlayer.type !== 'spy') {
        showError('فقط رئيس الجواسيس يمكنه استخدام هذا الوضع');
        return;
      }

      spymasterMode = !spymasterMode;
      elements.spymasterBtn.textContent = spymasterMode ? 
        'إيقاف وضع رئيس الجواسيس' : 
        'تشغيل وضع رئيس الجواسيس';
      
      updateBoard();
    }

    // Check if current player is spymaster
    function isSpymaster() {
      const currentPlayer = gameState.players[gameState.playerId];
      return currentPlayer && currentPlayer.type === 'spy';
    }

    // Pass turn
    function passTurn() {
      const currentPlayer = gameState.players[gameState.playerId];
      if (!currentPlayer) return;

      if (currentPlayer.team !== gameState.currentTurn) {
        showError('ليس دور فريقك');
        return;
      }

      switchTurn();
      addChatMessage('النظام', `${currentPlayer.name} مرر الدور`);
      updateDisplay();
    }

    // Update scores
    function updateScores() {
      elements.redScore.textContent = gameState.redScore;
      elements.blueScore.textContent = gameState.blueScore;
    }

    // Update turn indicator
    function updateTurnIndicator() {
      elements.turnIndicator.textContent = `دور الفريق ${gameState.currentTurn === 'red' ? 'الأحمر' : 'الأزرق'}`;
      elements.turnIndicator.style.backgroundColor = gameState.currentTurn === 'red' ? 
        'rgba(255, 107, 107, 0.3)' : 'rgba(72, 52, 212, 0.3)';
    }

    // Update players list
    function updatePlayersList() {
      elements.playersList.innerHTML = '';

      Object.values(gameState.players).forEach(player => {
        const playerDiv = document.createElement('div');
        playerDiv.className = 'player-item';
        
        const nameSpan = document.createElement('span');
        nameSpan.textContent = player.name;
        
        const roleSpan = document.createElement('span');
        roleSpan.className = 'player-role';
        roleSpan.textContent = `${player.type === 'spy' ? 'رئيس جواسيس' : 'عميل ميداني'} - ${player.team === 'red' ? 'أحمر' : 'أزرق'}`;
        roleSpan.style.color = player.team === 'red' ? '#ff6b6b' : '#6a5acd';
        
        playerDiv.appendChild(nameSpan);
        playerDiv.appendChild(roleSpan);
        elements.playersList.appendChild(playerDiv);
      });
    }

    // Show winner
    function showWinner() {
      elements.winnerText.textContent = `🎉 الفريق ${gameState.winner === 'red' ? 'الأحمر' : 'الأزرق'} يفوز!`;
      elements.winnerText.style.color = gameState.winner === 'red' ? '#ff6b6b' : '#6a5acd';
      elements.winnerModal.classList.remove('hidden');
      saveGameState();
    }

    // Close winner modal
    function closeWinnerModal() {
      elements.winnerModal.classList.add('hidden');
    }

    // New game
    function newGame() {
      if (!gameState.isRoomCreator) {
        showError('فقط منشئ الغرفة يمكنه بدء لعبة جديدة');
        return;
      }
      
      showLoading();
      
      gameState.cards = [];
      gameState.currentTurn = 'red';
      gameState.redScore = 9;
      gameState.blueScore = 8;
      gameState.winner = null;
      spymasterMode = false;
      
      elements.spymasterBtn.textContent = 'تشغيل وضع رئيس الجواسيس';
      
      generateCards();
      saveGameState();
      addChatMessage('النظام', 'بدأت لعبة جديدة!');
      
      hideLoading();
      closeWinnerModal();
    }

    // Chat functionality
    function sendMessage() {
      const message = elements.chatInput.value.trim();
      
      if (message && gameState.currentPlayer) {
        const chatRef = database.ref(`rooms/${gameState.roomCode}/chat`);
        chatRef.push({
          sender: gameState.currentPlayer,
          text: message,
          timestamp: new Date().getTime()
        });
        
        elements.chatInput.value = '';
      }
    }

    function addChatMessage(sender, message) {
      const messageDiv = document.createElement('div');
      messageDiv.className = 'chat-message';
      
      const time = new Date().toLocaleTimeString('ar-SA', { 
        hour: '2-digit', 
        minute: '2-digit' 
      });
      
      messageDiv.innerHTML = `
        <div>
          <span class="username">${sender}</span>
          <span class="time">${time}</span>
        </div>
        <div>${message}</div>
      `;
      
      elements.chatMessages.appendChild(messageDiv);
      elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
    }

    // Show error message
    function showError(message) {
      elements.errorContainer.innerHTML = `<div class="error-message">${message}</div>`;
      setTimeout(() => {
        elements.errorContainer.innerHTML = '';
      }, 3000);
    }

    // Show loading screen
    function showLoading() {
      elements.loadingScreen.classList.remove('hidden');
    }

    // Hide loading screen
    function hideLoading() {
      elements.loadingScreen.classList.add('hidden');
    }

    // Initialize event listeners
    function initEventListeners() {
      elements.createRoomBtn.addEventListener('click', createRoom);
      elements.joinGameBtn.addEventListener('click', joinGame);
      elements.spymasterBtn.addEventListener('click', toggleSpymaster);
      elements.passTurnBtn.addEventListener('click', passTurn);
      elements.newGameBtn.addEventListener('click', newGame);
      elements.newGameModalBtn.addEventListener('click', newGame);
      elements.closeWinnerBtn.addEventListener('click', closeWinnerModal);
      elements.sendMessageBtn.addEventListener('click', sendMessage);
      
      elements.chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          sendMessage();
        }
      });
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', () => {
      initEventListeners();
      
      // Add demo chat messages
      setTimeout(() => {
        addChatMessage('النظام', 'مرحباً بكم في لعبة كود نايمز أونلاين!');
        addChatMessage('النظام', 'انضم إلى غرفة أو أنشئ غرفة جديدة لتبدأ اللعب');
      }, 500);
    });
  </script>
</body>
</html>
