<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>كود نيمز أونلاين - مودرن وفخم</title>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f7f9fc;
    color: #222;
    margin: 0; padding: 0;
  }
  header {
    background: #2c3e50;
    color: #ecf0f1;
    text-align: center;
    padding: 1rem;
    font-size: 1.8rem;
    font-weight: bold;
    letter-spacing: 2px;
  }
  #container {
    max-width: 900px;
    margin: 1rem auto;
    padding: 1rem;
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 0 12px rgba(0,0,0,0.1);
  }
  input, button {
    font-size: 1.1rem;
    padding: 0.6rem 1rem;
    margin: 0.3rem 0.6rem 0.6rem 0;
    border-radius: 6px;
    border: 1px solid #ccc;
  }
  input:focus {
    outline: none;
    border-color: #2980b9;
    box-shadow: 0 0 5px #2980b9;
  }
  button {
    cursor: pointer;
    background: #2980b9;
    color: white;
    border: none;
    transition: background-color 0.3s ease;
  }
  button:hover {
    background: #1c5980;
  }
  .hidden {
    display: none;
  }
  h2 {
    margin-top: 0;
    color: #34495e;
  }
  #roles button {
    background: #bdc3c7;
    margin: 0.3rem 0.5rem 0.5rem 0;
  }
  #roles button.selected {
    background: #2980b9;
    color: white;
  }
  #board {
    margin-top: 1rem;
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 10px;
  }
  .card {
    background: #ecf0f1;
    border-radius: 8px;
    padding: 1rem;
    text-align: center;
    font-weight: 700;
    font-size: 1.2rem;
    cursor: pointer;
    user-select: none;
    transition: background-color 0.3s ease;
  }
  .card.red { background: #e74c3c; color: white; }
  .card.blue { background: #3498db; color: white; }
  .card.neutral { background: #95a5a6; color: white; }
  .card.assassin { background: #2c3e50; color: white; }
  .card.guessed {
    opacity: 0.6;
    cursor: default;
  }
  #playersList {
    margin-top: 1rem;
    font-weight: 600;
  }
  #info {
    margin-top: 1rem;
    font-size: 1.3rem;
    font-weight: bold;
  }
  #controls {
    margin-top: 1rem;
  }
  #error, #roleError {
    color: #e74c3c;
    margin: 0.5rem 0;
  }
</style>
</head>
<body>

<header>كود نيمز أونلاين - مودرن وفخم</header>
<div id="container">

  <div id="roomScreen">
    <h2>أنشئ أو ادخل غرفة</h2>
    <input id="roomName" placeholder="اسم الغرفة" />
    <button id="createBtn">إنشئ الغرفة</button>
    <button id="joinBtn">ادخل الغرفة</button>
    <div id="error"></div>

    <h3>الغرف المفتوحة</h3>
    <ul id="publicRooms"></ul>
  </div>

  <div id="roleScreen" class="hidden">
    <h2>ادخل اسمك واختر دورك</h2>
    <input id="playerName" placeholder="اسمك" />
    <div id="roles">
      <button class="role" data-role="spy">سباي ماستر</button>
      <button class="role" data-role="red">فريق أحمر</button>
      <button class="role" data-role="blue">فريق أزرق</button>
      <button class="role" data-role="neutral">مراقب</button>
    </div>
    <button id="joinGame">انضم للعبة</button>
    <button id="startGame" class="hidden">ابدأ اللعبة</button>
    <div id="roleError"></div>
  </div>

  <div id="gameScreen" class="hidden">
    <div id="info"></div>
    <div id="playersList"></div>
    <div id="board"></div>
    <div id="controls">
      <button id="pass">غيّر الدور</button>
      <button id="restart">إعادة اللعبة</button>
      <button id="leave">غادر الغرفة</button>
    </div>
  </div>

</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
  import { getDatabase, ref, set, get, onValue, push, update, remove } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDTAqaqpmPX0JYie21Gl2ysp1mHgKuw2EY",
    authDomain: "myupload-948bd.firebaseapp.com",
    databaseURL: "https://myupload-948bd-default-rtdb.firebaseio.com",
    projectId: "myupload-948bd",
    storageBucket: "myupload-948bd.appspot.com",
    messagingSenderId: "451397571101",
    appId: "1:451397571101:web:90b7cf96637819f734ecf4"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // كلمات اللعبة - أكثر من 300 كلمة عربية متنوعة
  const wordsPool = [
    "جبل", "بحر", "قمر", "شمس", "نهر", "صحراء", "طيارة", "سيارة", "حصان", "قطار",
    "كمبيوتر", "جوال", "مدينة", "قرية", "شارع", "مدرسة", "جامعة", "مستشفى", "كتاب",
    "قلم", "كوب", "ساعة", "شباك", "باب", "نار", "ثلج", "مطر", "ريح", "غيمة", "ظل",
    "ضوء", "ظلام", "أمل", "حب", "صداقة", "عدو", "قوة", "ضعف", "علم", "جهل", "سر",
    "حقيقة", "خداع", "نفاق", "إخلاص", "خوف", "شجاعة", "أمن", "حرب", "سلام", "سياسة",
    "اقتصاد", "نفط", "ذهب", "فضة", "حديد", "تراب", "ماء", "هواء", "خشب", "زجاج",
    "ملح", "سكر", "فلفل", "بحيرة", "وادي", "شجرة", "زهرة", "طيور", "أسد", "نمر",
    "ذئب", "عسل", "قهوة", "شاي", "مطبخ", "مسرح", "سينما", "فن", "موسيقى", "رياضة",
    "كرة", "سباحة", "جري", "قفز", "سماء", "نجوم", "قمر صناعي", "بركان", "زلازل",
    "عاصفة", "ثلوج", "صيف", "شتاء", "خريف", "ربيع", "كهرباء", "ميكانيكا", "برمجة",
    "حاسوب", "موبايل", "إنترنت", "شبكة", "تلفاز", "راديو", "كاميرا", "عدسة", "صورة",
    "فيديو", "شجرة زيتون", "تفاح", "موز", "عنب", "برتقال", "خضار", "فواكه", "سمك",
    "دجاج", "لحم", "مخبز", "خبز", "سوق", "مطار", "مكتب", "بابا", "ماما", "أخ", "أخت",
    "طفل", "شباب", "رجل", "امرأة", "مدينة كبيرة", "قرية صغيرة", "حديقة", "نافورة",
    "جسر", "نفق", "طريق", "سيارة سباق", "دراجة", "حافلة", "قطار سريع", "سفينة",
    "مركبة فضائية", "صاروخ", "فضاء", "كوكب", "نجوم", "مجرة", "ثقب أسود", "نجم", "قمر",
    "شمس", "مطر", "ثلج", "برد", "حر", "ريح", "عاصفة", "برق", "رعد", "غيمة", "سماء",
    "بحر", "محيط", "جزيرة", "شاطئ", "رمل", "صخور", "كهف", "جبل", "وادي", "غابة",
    "نباتات", "زهور", "حيوانات", "أسد", "نمر", "ذئب", "فيل", "زرافة", "قرد", "دب",
    "نملة", "نحل", "عنكبوت", "فراشة", "عصفور", "بطة", "ببغاء", "حمامة", "بومة",
    "سمكة", "قرش", "سلحفاة", "تمساح", "دولفين", "حوت", "قرش", "صقر", "نسر", "بقرة",
    "حصان", "جمل", "خروف", "ماعز", "ديك", "دجاجة", "بقرة", "خنزير", "فأر", "أرنب",
    "مطرقة", "منشار", "مفتاح", "برغي", "مسمار", "مفك", "مقصة", "سكاكين", "شوكة",
    "ملعقة", "صحن", "كوب", "زجاجة", "قلم", "دفتر", "كتاب", "حقيبة", "حذاء", "قبعة",
    "نظارات", "ساعة", "هاتف", "حاسوب", "كاميرا", "تلفاز", "راديو", "صابون", "شامبو",
    "معجون أسنان", "فرشاة", "منشفة", "سرير", "وسادة", "بطانية", "كرسي", "طاولة",
    "مصباح", "نافذة", "باب", "جدار", "سقف", "أرضية", "سلالم", "مكتب", "خزانة",
    "ثلاجة", "فرن", "موقد", "مغسلة", "حنفية", "دلو", "مكنسة", "ممسحة", "مروحة",
    "مكيف", "مدفأة", "ساونا", "حمام", "مسبح", "حديقة", "زهرة", "شجرة", "عشب",
    "صخرة", "نهر", "شلال", "بحيرة", "مزرعة", "حقول", "ماشية", "حصان", "كلب", "قط",
    "فأر", "عصفور", "نملة", "نحل", "دبور", "فراشة", "سلحفاة", "ضفدع", "ثعبان",
    "عنكبوت", "دجاجة", "ديك", "بطة", "ببغاء", "حمامة", "بومة", "صقر", "نسر",
    "حوت", "دولفين", "قرش", "تمساح", "ضبع", "ذئب", "أسد", "نمر", "فهد", "فيل",
    "زرافة", "قرد", "غوريلا", "بابون", "تنين", "جنية", "مصباح سحري", "كنز",
    "قلعة", "حصن", "برج", "مدينة قديمة", "سوق", "شارع", "شارع ضيق", "حانة",
    "مطبخ", "مسرح", "سينما", "متحف", "مكتبة", "مدرسة", "جامعة", "مستشفى", "مصنع",
    "مصنع سيارات", "مخزن", "مزرعة", "حديقة حيوانات", "حديقة نباتات", "مطار",
    "محطة قطار", "محطة حافلات", "مكتبة عامة", "مقهى", "مطعم", "سوق", "محل تجاري",
    "مبنى إداري", "مبنى سكني", "شارع رئيسي", "شارع جانبي", "ممر", "موقف سيارات",
    "مصعد", "سلالم كهربائية", "باب دوار", "نفق", "جسر", "شارع معبد", "شارع ترابي"
  ];

  // عناصر الصفحة
  const roomScreen = document.getElementById("roomScreen");
  const roleScreen = document.getElementById("roleScreen");
  const gameScreen = document.getElementById("gameScreen");

  const roomNameInput = document.getElementById("roomName");
  const createBtn = document.getElementById("createBtn");
  const joinBtn = document.getElementById("joinBtn");
  const errorDiv = document.getElementById("error");
  const publicRoomsList = document.getElementById("publicRooms");

  const playerNameInput = document.getElementById("playerName");
  const rolesButtons = document.querySelectorAll("#roles button.role");
  const joinGameBtn = document.getElementById("joinGame");
  const startGameBtn = document.getElementById("startGame");
  const roleErrorDiv = document.getElementById("roleError");

  const infoDiv = document.getElementById("info");
  const playersListDiv = document.getElementById("playersList");
  const boardDiv = document.getElementById("board");
  const passBtn = document.getElementById("pass");
  const restartBtn = document.getElementById("restart");
  const leaveBtn = document.getElementById("leave");

  let roomName = "";
  let playerName = "";
  let playerRole = "";
  let playerId = "";
  let gameData = null;
  let currentTurn = null;
  let cards = [];
  let teamRedCount = 0;
  let teamBlueCount = 0;

  // اختار الدور مع تفعيل الزر المختار
  rolesButtons.forEach(btn => {
    btn.onclick = () => {
      rolesButtons.forEach(b => b.classList.remove("selected"));
      btn.classList.add("selected");
      playerRole = btn.dataset.role;
      roleErrorDiv.textContent = "";
    };
  });

  // تابع لجلب الغرف العامة المفتوحة
  function loadPublicRooms() {
    const roomsRef = ref(db, "rooms/");
    get(roomsRef).then(snapshot => {
      publicRoomsList.innerHTML = "";
      if (!snapshot.exists()) return;
      const rooms = snapshot.val();
      for (const r in rooms) {
        if (rooms[r].started) continue;
        const li = document.createElement("li");
        li.textContent = r;
        li.style.cursor = "pointer";
        li.onclick = () => {
          roomNameInput.value = r;
        };
        publicRoomsList.appendChild(li);
      }
    });
  }
  loadPublicRooms();

  // انشئ غرفة جديدة
  createBtn.onclick = () => {
    const rn = roomNameInput.value.trim();
    if (!rn) {
      errorDiv.textContent = "اكتب اسم الغرفة أولاً";
      return;
    }
    errorDiv.textContent = "";
    const roomRef = ref(db, `rooms/${rn}`);
    get(roomRef).then(snapshot => {
      if (snapshot.exists()) {
        errorDiv.textContent = "الغرفة موجودة مسبقاً، جرب اسم ثاني";
      } else {
        // إنشاء الغرفة
        set(roomRef, {
          started: false,
          players: {},
          board: {},
          turn: null,
          passed: false,
          winner: null
        }).then(() => {
          roomName = rn;
          roomScreen.classList.add("hidden");
          roleScreen.classList.remove("hidden");
          startGameBtn.classList.add("hidden");
          loadPlayers(roomName);
        });
      }
    });
  };

  // ادخل غرفة موجودة
  joinBtn.onclick = () => {
    const rn = roomNameInput.value.trim();
    if (!rn) {
      errorDiv.textContent = "اكتب اسم الغرفة أولاً";
      return;
    }
    errorDiv.textContent = "";
    const roomRef = ref(db, `rooms/${rn}`);
    get(roomRef).then(snapshot => {
      if (!snapshot.exists()) {
        errorDiv.textContent = "الغرفة غير موجودة";
      } else {
        roomName = rn;
        roomScreen.classList.add("hidden");
        roleScreen.classList.remove("hidden");
        startGameBtn.classList.add("hidden");
        loadPlayers(roomName);
      }
    });
  };

  // انضمام للعبة بعد اختيار الدور والاسم
  joinGameBtn.onclick = () => {
    const pn = playerNameInput.value.trim();
    if (!pn) {
      roleErrorDiv.textContent = "اكتب اسمك";
      return;
    }
    if (!playerRole) {
      roleErrorDiv.textContent = "اختر دورك";
      return;
    }
    roleErrorDiv.textContent = "";
    playerName = pn;
    playerId = `${playerName}-${Date.now()}`; // معرف فريد
    const playersRef = ref(db, `rooms/${roomName}/players/${playerId}`);

    // نضيف اللاعب إلى الغرفة
    set(playersRef, {
      name: playerName,
      role: playerRole,
      ready: false
    }).then(() => {
      roleScreen.classList.add("hidden");
      gameScreen.classList.remove("hidden");
      if (playerRole === "spy") {
        startGameBtn.classList.remove("hidden");
      }
      updatePlayersList();
      listenGameChanges();
    });
  };

  // تحديث قائمة اللاعبين
  function updatePlayersList() {
    const playersRef = ref(db, `rooms/${roomName}/players`);
    get(playersRef).then(snapshot => {
      if (!snapshot.exists()) {
        playersListDiv.textContent = "لا يوجد لاعبين";
        return;
      }
      const players = snapshot.val();
      playersListDiv.innerHTML = "<b>اللاعبين في الغرفة:</b><br>";
      for (const id in players) {
        const p = players[id];
        playersListDiv.innerHTML += `${p.name} - ${roleName(p.role)}<br>`;
      }
    });
  }
  // اسم الدور بالعربية
  function roleName(role) {
    switch (role) {
      case "spy": return "سباي ماستر";
      case "red": return "الفريق الأحمر";
      case "blue": return "الفريق الأزرق";
      case "neutral": return "مراقب";
      default: return "";
    }
  }

  // استمع لتحديثات اللعبة
  function listenGameChanges() {
    const roomRef = ref(db, `rooms/${roomName}`);
    onValue(roomRef, snapshot => {
      if (!snapshot.exists()) return;
      gameData = snapshot.val();

      // تحديث الدور الحالي
      currentTurn = gameData.turn;

      // تحديث المعلومات أسفل
      if (gameData.winner) {
        infoDiv.textContent = `انتهت اللعبة! الفريق الفائز: ${roleName(gameData.winner)}`;
      } else if (currentTurn) {
        infoDiv.textContent = `دور الفريق: ${roleName(currentTurn)}`;
      } else {
        infoDiv.textContent = "اللعبة لم تبدأ بعد";
      }

      // عرض اللوح
      if (gameData.board && Object.keys(gameData.board).length > 0) {
        cards = Object.entries(gameData.board).map(([word, data]) => ({ word, ...data }));
        renderBoard();
      }

      // تحديث زر بدء اللعبة للسباي ماستر (إذا اللعبة ما بدأت)
      if (!gameData.started && playerRole === "spy") {
        startGameBtn.classList.remove("hidden");
      } else {
        startGameBtn.classList.add("hidden");
      }
      updatePlayersList();
    });
  }

  // رسم اللوح
  function renderBoard() {
    boardDiv.innerHTML = "";
    cards.forEach(card => {
      const cardEl = document.createElement("div");
      cardEl.classList.add("card");
      cardEl.textContent = card.word;
      if (card.guessed) cardEl.classList.add("guessed");
      else cardEl.classList.add(card.color);
      cardEl.onclick = () => {
        if (gameData.winner) return; // انتهت اللعبة
        if (playerRole !== currentTurn) return; // مو دورك تلعب
        if (card.guessed) return; // الكلمة مصيدة

        guessCard(card.word);
      };
      boardDiv.appendChild(cardEl);
    });
  }

  // التخمين - علامة على كلمة
  function guessCard(word) {
    if (!gameData.board[word] || gameData.board[word].guessed) return;
    const cardColor = gameData.board[word].color;
    const isTurnRed = (gameData.turn === "red");
    const isTurnBlue = (gameData.turn === "blue");

    // إذا الكلمة قاتلة (assassin)
    if (cardColor === "assassin") {
      update(ref(db, `rooms/${roomName}`), {
        winner: (isTurnRed ? "blue" : "red"),
        started: false
      });
      return;
    }

    // علامة على الكلمة
    update(ref(db, `rooms/${roomName}/board/${word}`), { guessed: true });

    // خصم كلمة من الفريق الحالي إذا صحيحة
    if ((cardColor === "red" && isTurnRed) || (cardColor === "blue" && isTurnBlue)) {
      if (cardColor === "red") teamRedCount--;
      else teamBlueCount--;

      // لو انتهت كلمات الفريق، الفوز له
      if (teamRedCount === 0) {
        update(ref(db, `rooms/${roomName}`), { winner: "red", started: false });
      }
      if (teamBlueCount === 0) {
        update(ref(db, `rooms/${roomName}`), { winner: "blue", started: false });
      }
      // يبقى نفس الفريق يلعب
    } else {
      // أخطأ، ينتقل الدور
      const nextTurn = (gameData.turn === "red") ? "blue" : "red";
      update(ref(db, `rooms/${roomName}`), { turn: nextTurn });
    }
  }

  // بدء اللعبة
  startGameBtn.onclick = () => {
    if (gameData && !gameData.started) {
      // تهيئة اللعبة
      const shuffledWords = shuffle(words).slice(0, 25);
      cards = [];
      teamRedCount = 9;
      teamBlueCount = 8;
      const board = {};

      // توزيع الألوان
      const colors = [];
      for (let i = 0; i < 9; i++) colors.push("red");
      for (let i = 0; i < 8; i++) colors.push("blue");
      for (let i = 0; i < 7; i++) colors.push("neutral");
      colors.push("assassin");

      shuffle(colors);

      shuffledWords.forEach((word, idx) => {
        board[word] = {
          color: colors[idx],
          guessed: false
        };
      });

      const turn = "red";

      set(ref(db, `rooms/${roomName}`), {
        started: true,
        players: gameData.players,
        board,
        turn,
        passed: false,
        winner: null
      });
    }
  };

  // اعادة تشغيل اللعبة
  restartBtn.onclick = () => {
    if (!roomName) return;
    const roomRef = ref(db, `rooms/${roomName}`);
    get(roomRef).then(snapshot => {
      if (!snapshot.exists()) return;
      const data = snapshot.val();
      set(ref(db, `rooms/${roomName}`), {
        started: false,
        players: data.players || {},
        board: {},
        turn: null,
        passed: false,
        winner: null
      });
      roleScreen.classList.remove("hidden");
      gameScreen.classList.add("hidden");
    });
  };

  // مغادرة الغرفة
  leaveBtn.onclick = () => {
    if (!roomName || !playerId) return;
    const playerRef = ref(db, `rooms/${roomName}/players/${playerId}`);
    remove(playerRef).then(() => {
      playerId = "";
      playerRole = "";
      playerName = "";
      roomName = "";
      gameData = null;
      currentTurn = null;
      cards = [];
      teamRedCount = 0;
      teamBlueCount = 0;
      roleScreen.classList.add("hidden");
      gameScreen.classList.add("hidden");
      roomScreen.classList.remove("hidden");
      loadPublicRooms();
    });
  };

  // دمج مصفوفة (shuffle)
  function shuffle(array) {
    for (let i = array.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
  }
</script>
</body>
</html>يا سلام عليك، كود لعبة Codenames كامل وقوي! تبي شرير؟ حاضر، خلني أقول لك كيف تقدر تضيف كود شرير يخلي اللعبة تشتغل مع أغراض غير متوقعة وتعبث شوية بالخوارزمية لكن بشكل ذكي.

مثلاً، لو تبي تخلي اللعبة تعطي فرص أكثر للفريق الأزرق (مخفيًا)، تقدر تعدل دالة startGameBtn.onclick بحيث:

```js
startGameBtn.onclick = () => {
  if (gameData && !gameData.started) {
    const shuffledWords = shuffle(words).slice(0, 25);
    cards = [];
    // زيادة عدد كلمات الفريق الأزرق على حساب الأحمر، بس لازم تكون متوازن شوي
    teamRedCount = 7;  // بدل 9
    teamBlueCount = 10; // بدل 8
    const board = {};

    const colors = [];
    for (let i = 0; i < 7; i++) colors.push("red");
    for (let i = 0; i < 10; i++) colors.push("blue");
    for (let i = 0; i < 7; i++) colors.push("neutral");
    colors.push("assassin");

    shuffle(colors);

    shuffledWords.forEach((word, idx) => {
      board[word] = {
        color: colors[idx],
        guessed: false
      };
    });

    const turn = "red";

    set(ref(db, `rooms/${roomName}`), {
      started: true,
      players: gameData.players,
      board,
      turn,
      passed: false,
      winner: null
    });
  }
};
