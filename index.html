<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Codenames Online - شرير & مطيع</title>
  <style>
    /* نفس التنسيقات القديمة + تحسينات بسيطة */
    body { font-family: Tahoma, Arial, sans-serif; background:#111; color:#eee; }
    header { font-size: 2em; text-align: center; margin: 1rem 0; }
    main { max-width: 900px; margin: auto; }
    .panel { background: #222; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; }
    #board { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; }
    .card {
      background: #444; padding: 1rem; border-radius: 6px; cursor: pointer;
      user-select: none; text-align: center; font-weight: bold;
      transition: background-color 0.3s;
    }
    .card.guessed { opacity: 0.6; cursor: default; }
    .card.red { background: #a00; color: #fee; }
    .card.blue { background: #006; color: #cdf; }
    .card.neutral { background: #666; color: #ccc; }
    .card.assassin { background: #000; color: #f00; }
    .chat-box { margin-top: 1rem; background: #333; border-radius: 6px; padding: 0.5rem; max-height: 200px; overflow-y: auto; }
    .chat-input { display: flex; margin-top: 0.5rem; }
    .chat-input input { flex: 1; padding: 0.5rem; border-radius: 4px 0 0 4px; border: none; }
    .chat-input button { padding: 0.5rem 1rem; border: none; border-radius: 0 4px 4px 0; background: #009688; color: #fff; cursor: pointer; }
    #playersList div { margin: 5px 0; }
    .role.spy { color: #f88; }
    .role.field { color: #88f; }
  </style>
</head>
<body>

<header>لعبة Codenames Online - شرير & مطيع</header>

<main>
  <section class="panel" id="roomPanel">
    <label>اسمك:</label><input type="text" id="usernameInput" autocomplete="off" />
    <label>اسم الغرفة:</label><input type="text" id="roomNameInput" autocomplete="off" />
    <label>دورك:</label>
    <select id="roleSelect">
      <option value="field">مخبر ميداني</option>
      <option value="spy">سباي ماستر</option>
    </select>
    <button id="joinRoomBtn">انضم للغرفة وابدأ اللعب</button>
    <div id="playersList"></div>
  </section>

  <section class="panel" id="gamePanel" style="display:none;">
    <div id="turnIndicator">دور: ...</div>
    <div id="playersRoles"></div>
    <div id="board" aria-label="لوحة الكلمات"></div>

    <button id="toggleSpymasterBtn">تشغيل وضع المخبر</button>
    <button id="passTurnBtn">تمرر الدور</button>

    <div class="chat-box" id="chatMessages" aria-live="polite"></div>
    <div class="chat-input">
      <input id="chatInput" placeholder="اكتب رسالة..." autocomplete="off" />
      <button id="sendChatBtn">إرسال</button>
    </div>

    <div id="winnerMessage" style="display:none; font-size: 1.5rem; margin-top: 1rem; color: #0f0;"></div>
  </section>
</main>

<script type="module">
// === Firebase SDK ===
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.24.0/firebase-app.js";
import {
  getFirestore, doc, getDoc, setDoc, updateDoc,
  onSnapshot, arrayUnion, arrayRemove
} from "https://www.gstatic.com/firebasejs/9.24.0/firebase-firestore.js";

// تهيئة فايربيز مع config حقك
const firebaseConfig = {
  apiKey: "AIzaSyDTAqaqpmPX0JYie21Gl2ysp1mHgKuw2EY",
  authDomain: "myupload-948bd.firebaseapp.com",
  projectId: "myupload-948bd",
  storageBucket: "myupload-948bd.firebasestorage.app",
  messagingSenderId: "451397571101",
  appId: "1:451397571101:web:90b7cf96637819f734ecf4"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// الكلمات 25 كلمة من 300 تقريبا (اختصار)
// زيدهم بنفسك لو تبي
const words = [
  "تيتانيوم", "كربون", "موسيقى", "رسم", "تصوير", "رقص", "غناء", "تمثيل", "أدب", "شعر",
  "مسرح", "سينما", "حوت", "دلفين", "قرش", "سلحفاة", "طائر", "فيل", "زرافة", "قرد",
  "دب", "ثعلب", "حاسوب", "هاتف", "كاميرا"
];

const COLORS = {
  RED: "red",
  BLUE: "blue",
  NEUTRAL: "neutral",
  ASSASSIN: "assassin"
};

let currentPlayer = null;
let currentRoom = null;
let isSpymasterView = false;
let gameData = null;

// التوزيع والأدوار
async function generateGameData() {
  const selectedWords = [];
  while (selectedWords.length < 25) {
    const w = words[Math.floor(Math.random() * words.length)];
    if (!selectedWords.includes(w)) selectedWords.push(w);
  }

  const colors = [];
  for (let i=0; i<9; i++) colors.push(COLORS.RED);
  for (let i=0; i<8; i++) colors.push(COLORS.BLUE);
  for (let i=0; i<7; i++) colors.push(COLORS.NEUTRAL);
  colors.push(COLORS.ASSASSIN);
  shuffle(colors);

  const cards = selectedWords.map((word, i) => ({
    word,
    color: colors[i],
    guessed: false
  }));

  return {
    cards,
    turn: COLORS.RED,
    winner: null,
    players: {},
    chat: []
  };
}

function shuffle(arr) {
  for (let i = arr.length -1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i+1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
}

function buildBoard() {
  const board = document.getElementById("board");
  board.innerHTML = "";
  gameData.cards.forEach((card, idx) => {
    const div = document.createElement("div");
    div.className = "card";
    div.textContent = card.word;
    div.dataset.index = idx;

    if (card.guessed) {
      div.classList.add("guessed", card.color);
    } else if (isSpymasterView && isCurrentPlayerSpyMaster()) {
      div.classList.add("show-color", card.color);
    }

    div.addEventListener("click", () => onCardClick(idx));
    board.appendChild(div);
  });
  updateInfo();
}

function updateInfo() {
  const redLeft = gameData.cards.filter(c => c.color === COLORS.RED && !c.guessed).length;
  const blueLeft = gameData.cards.filter(c => c.color === COLORS.BLUE && !c.guessed).length;
  document.getElementById("redLeft")?.textContent = redLeft;
  document.getElementById("blueLeft")?.textContent = blueLeft;
  setTurnText();
}

function setTurnText() {
  const turnIndicator = document.getElementById("turnIndicator");
  turnIndicator.textContent = `دور: الفريق ${gameData.turn === COLORS.RED ? "الأحمر" : "الأزرق"}`;
}

function isCurrentPlayerSpyMaster() {
  if (!currentPlayer || !gameData) return false;
  const p = gameData.players[currentPlayer];
  if (!p) return false;
  return p.role === "spy";
}

async function onCardClick(idx) {
  if (!gameData || gameData.winner) return alert("اللعبة انتهت أو غير جاهزة");

  const p = gameData.players[currentPlayer];
  if (!p) return alert("أنت مش لاعب في الغرفة");
  if (p.role === "spy") return alert("المخبر ما يقدر يخمن");

  if (gameData.turn !== p.team) return alert("مو دور فريقك");

  const card = gameData.cards[idx];
  if (card.guessed) return;

  card.guessed = true;

  if (card.color === COLORS.ASSASSIN) {
    gameData.winner = gameData.turn === COLORS.RED ? COLORS.BLUE : COLORS.RED;
    alert(`انتهت اللعبة! الفريق ${gameData.winner} فاز لأنهم لقوا القاتل!`);
  } else if (card.color !== gameData.turn) {
    gameData.turn = gameData.turn === COLORS.RED ? COLORS.BLUE : COLORS.RED;
    alert("كلمة للفريق الثاني، تم تمرير الدور");
  }

  // تحقق إذا فاز الفريق الحالي
  const left = gameData.cards.filter(c => c.color === gameData.turn && !c.guessed).length;
  if (left === 0) {
    gameData.winner = gameData.turn;
    alert(`الفريق ${gameData.winner} فاز!`);
  }

  await updateGameData(gameData);
}

async function updateGameData(data) {
  const roomDoc = doc(db, "rooms", currentRoom);
  await setDoc(roomDoc, data);
}

async function joinRoom(name, room, role) {
  currentPlayer = name;
  currentRoom = room;

  const roomDoc = doc(db, "rooms", room);
  const roomSnap = await getDoc(roomDoc);

  if (!roomSnap.exists()) {
    // غرفة جديدة، نبدأ من الصفر
    gameData = await generateGameData();
    gameData.players[name] = { role, team: assignTeam(Object.keys(gameData.players)) };
    await setDoc(roomDoc, gameData);
  } else {
    gameData = roomSnap.data();
    if (!gameData.players[name]) {
      gameData.players[name] = { role, team: assignTeam(Object.keys(gameData.players)) };
      await updateGameData(gameData);
    }
  }

  document.getElementById("roomPanel").style.display = "none";
  document.getElementById("gamePanel").style.display = "block";

  listenToRoomUpdates(roomDoc);
  updatePlayersList();
  buildBoard();
}

function assignTeam(playersList) {
  const redCount = playersList.filter(p => gameData.players[p]?.team === COLORS.RED).length;
  const blueCount = playersList.filter(p => gameData.players[p]?.team === COLORS.BLUE).length;
  return redCount <= blueCount ? COLORS.RED : COLORS.BLUE;
}

function listenToRoomUpdates(roomDoc) {
  onSnapshot(roomDoc, (docSnap) => {
    if (!docSnap.exists()) return;
    gameData = docSnap.data();
    updatePlayersList();
    buildBoard();
    updateWinnerMessage();
  });
}

function updatePlayersList() {
  const playersList = document.getElementById("playersList");
  playersList.innerHTML = "";
  for (const name in gameData.players) {
    const p = document.createElement("div");
    p.textContent = name;
    const roleSpan = document.createElement("span");
    roleSpan.textContent = gameData.players[name].role === "spy" ? "مخبر" : "مخبر ميداني";
    roleSpan.className = "role " + (gameData.players[name].role === "spy" ? "spy" : "field");
    p.appendChild(roleSpan);
    playersList.appendChild(p);
  }
}

function updateWinnerMessage() {
  const wm = document.getElementById("winnerMessage");
  if (gameData.winner) {
    wm.style.display = "block";
    wm.textContent = `فاز الفريق ${gameData.winner === COLORS.RED ? "الأحمر" : "الأزرق"}! مبروك!`;
  } else {
    wm.style.display = "none";
  }
}

// زر تبديل وضع المخبر
document.getElementById("toggleSpymasterBtn").onclick = () => {
  if (!isCurrentPlayerSpyMaster()) return alert("فقط المخبر يقدر يشغل وضع المخبر");
  isSpymasterView = !isSpymasterView;
  buildBoard();
};

// زر تمرير الدور
document.getElementById("passTurnBtn").onclick = async () => {
  if (!gameData) return;
  if (gameData.winner) return alert("اللعبة انتهت");

  if (gameData.turn === COLORS.RED) gameData.turn = COLORS.BLUE;
  else gameData.turn = COLORS.RED;

  await updateGameData(gameData);
};

// إرسال رسالة الدردشة
document.getElementById("sendChatBtn").onclick = async () => {
  const input = document.getElementById("chatInput");
  const text = input.value.trim();
  if (!text) return;
  if (!currentPlayer) return alert("حدد اسمك أولاً");

  if (!gameData.chat) gameData.chat = [];
  gameData.chat.push({
    user: currentPlayer,
    text,
    time: new Date().toLocaleTimeString()
  });

  await updateGameData(gameData);
  input.value = "";
};

document.getElementById("chatInput").addEventListener("keydown", (e) => {
  if (e.key === "Enter") {
    document.getElementById("sendChatBtn").click();
  }
});

// زر الانضمام للغرفة
document.getElementById("joinRoomBtn").onclick = async () => {
  const name = document.getElementById("usernameInput").value.trim();
  const room = document.getElementById("roomNameInput").value.trim();
  const role = document.getElementById("roleSelect").value;

  if (!name || !room) return alert("لازم تكتب اسمك واسم الغرفة");

  await joinRoom(name, room, role);
};

// عرض رسائل الدردشة
function renderChatMessages() {
  const chatDiv = document.getElementById("chatMessages");
  chatDiv.innerHTML = "";
  if (!gameData?.chat) return;
  gameData.chat.forEach(m => {
    const div = document.createElement("div");
    div.innerHTML = `<strong>${m.user}</strong> [${m.time}]: ${m.text}`;
    chatDiv.appendChild(div);
  });
  chatDiv.scrollTop = chatDiv.scrollHeight;
}

// تحديث الدردشة مع التحديثات
function updatePlayersList() {
  const playersList = document.getElementById("playersList");
  playersList.innerHTML = "";
  if (!gameData?.players) return;
  for (const name in gameData.players) {
    const p = document.createElement("div");
    p.textContent = name;
    const roleSpan = document.createElement("span");
    roleSpan.textContent = gameData.players[name].role === "spy" ? "مخبر" : "مخبر ميداني";
    roleSpan.className = "role " + (gameData.players[name].role === "spy" ? "spy" : "field");
    p.appendChild(roleSpan);
    playersList.appendChild(p);
  }
  renderChatMessages();
}

// تعديل بناء اللوحة عشان يحدث تلقائياً مع كل تحديث
function buildBoard() {
  const board = document.getElementById("board");
  board.innerHTML = "";
  if (!gameData || !gameData.cards) return;

  gameData.cards.forEach((card, idx) => {
    const div = document.createElement("div");
    div.className = "card";
    div.textContent = card.word;
    div.dataset.index = idx;

    if (card.guessed) {
      div.classList.add("guessed", card.color);
      div.style.cursor = "default";
    } else if (isSpymasterView && isCurrentPlayerSpyMaster()) {
      div.classList.add(card.color);
    }

    div.onclick = () => onCardClick(idx);

    board.appendChild(div);
  });
  setTurnText();
  updateWinnerMessage();
}

</script>
</body>
</html>
